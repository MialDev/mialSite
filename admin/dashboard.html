<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Dashboard ‚Äî mial</title>
    <link rel="icon" type="image/svg+xml" href="/assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="/style.css">

    <!-- Admin Guard -->
    <script src="/api.js"></script>
    <script>
        (async () => {
            try {
                const res = await fetch(apiUrl('/me'), { credentials: 'include' });
                if (!res.ok) {
                    if (res.status === 401) window.location.replace('/login.html');
                    else window.location.replace('/dashboard.html');
                    return;
                }
                const user = await res.json();
                if (user.role !== 'admin' && user.is_admin !== true) {
                    window.location.replace('/dashboard.html');
                }
            } catch (e) {
                window.location.replace('/login.html');
            }
        })();
    </script>

    <meta name="theme-color" content="#1fb6ff">
    <style>
        .action-btn {
            padding: 4px 8px;
            font-size: 0.85rem;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            background: white;
        }

        .action-btn:hover {
            background: #f8fafc;
        }

        .badge-active {
            background: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-inactive {
            background: #f1f5f9;
            color: #64748b;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <header id="site-header" class="nav">
        <div class="container nav-inner">
            <a href="/admin/dashboard.html" class="brand">
                <img class="brand-logo" src="/assets/logos/logo-mial-full-color.svg" alt="mial logo" width="88"
                    height="88">
            </a>
            <button class="nav-toggle" type="button" aria-label="Ouvrir le menu">
                <span class="nav-toggle-bar"></span>
            </button>
            <nav class="nav-links">
                <a href="/accueil.html">Accueil</a>
                <a href="/admin/dashboard.html" style="font-weight: 600;">Admin</a>
                <a href="/admin/analytics.html">Analytics</a>
                <a href="/dashboard.html">User View</a>
                <button id="logout-btn" class="btn btn-ghost"
                    style="border:none; background:transparent; font-size: 0.95rem; cursor:pointer;">D√©connexion</button>
            </nav>
        </div>
    </header>

    <section class="section" style="padding-top: 140px;">
        <div class="container">
            <!-- Hero -->
            <div class="card glass-static" style="margin-bottom: 32px; padding: 32px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h1 style="font-size: 1.8rem; margin-bottom: 8px;">Admin Dashboard</h1>
                        <p class="muted">Administration globale</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <a href="/admin/analytics.html" class="btn btn-ghost btn-small">Analytics</a>
                        <a href="/dashboard.html" class="btn btn-primary btn-small">User Dashboard</a>
                    </div>
                </div>
            </div>

            <!-- Hierarchy Container -->
            <div class="card glass-static" style="padding: 24px; min-height: 400px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="font-size: 1.5rem; margin:0;">Utilisateurs & Profils</h2>
                    <button class="action-btn" onclick="initDashboard()">Rafra√Æchir tout</button>
                </div>

                <div id="hierarchy-root">
                    <div style="text-align:center; padding: 40px;" class="muted">Chargement...</div>
                </div>
            </div>

            <!-- Profile Editor (Hidden by default) -->
            <section id="profile-editor" class="card glass-static"
                style="margin-top:24px; display:none; border: 2px solid #3b82f6;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <div>
                        <h3 style="margin:0;">√âditeur de Profil (Admin)</h3>
                        <div class="muted" style="font-size:0.9rem;">ID: <span id="edit-profile-id"></span></div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-ghost btn-small" id="btn-delete-profile"
                            style="color:#ef4444; border-color:#ef4444;">Supprimer Profil</button>
                        <button class="btn btn-ghost btn-small" id="editor-close">Fermer</button>
                    </div>
                </div>

                <div id="editor-error" style="display:none; margin-top:12px; color:#ef4444; font-size:0.95rem;"></div>
                <div id="editor-ok" style="display:none; margin-top:12px; color:#16a34a; font-size:0.95rem;"></div>

                <!-- Assignment Block -->
                <div id="admin-assign-block"
                    style="margin-top:16px; padding:16px; background:rgba(31,182,255,0.05); border-radius:8px; border:1px solid rgba(31,182,255,0.2);">
                    <h4 style="margin:0 0 12px 0; font-size:1rem;">Assignation</h4>
                    <div style="display:flex; gap:8px; align-items:flex-end;">
                        <label style="flex:1;">Email utilisateur (Propri√©taire)
                            <input id="f-assign-email" type="email" placeholder="client@example.com" />
                        </label>
                        <button class="btn btn-primary btn-small" id="btn-assign">Assigner</button>
                        <button class="btn btn-ghost btn-small" id="btn-unassign"
                            style="display:none;">D√©sassigner</button>
                    </div>
                    <div id="assign-status" style="margin-top:8px; font-size:0.9rem; color: #64748b;"></div>
                </div>

                <!-- Form -->
                <form id="form-settings" class="form" style="margin-top:16px;">
                    <!-- Horaires -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid #eee; padding-bottom: 8px;">Horaires
                        </h4>
                        <label>Timezone
                            <input id="f-timezone" type="text" placeholder="Europe/Brussels" />
                        </label>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <label>Heure d√©but
                                <input id="f-start" type="time" step="1" />
                            </label>
                            <label>Heure fin
                                <input id="f-end" type="time" step="1" />
                            </label>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid #eee; padding-bottom: 8px;">Filtres &
                            Historique</h4>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <label>Jours arri√®re START
                                <input id="f-days-start" type="number" min="0" max="30" placeholder="1" />
                            </label>
                            <label>Jours arri√®re END
                                <input id="f-days-end" type="number" min="0" max="30" placeholder="1" />
                            </label>
                        </div>
                        <!-- CSV Filters -->
                        <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <label>Exp√©diteurs autoris√©s
                                <input id="f-filter-sender" type="text" placeholder="@gmail.com, ..." />
                            </label>
                            <label>Exp√©diteurs exclus
                                <input id="f-filter-exclude" type="text" placeholder="no-reply, ..." />
                            </label>
                        </div>
                        <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            <label>CC autoris√©s
                                <input id="f-filter-cc" type="text" placeholder="" />
                            </label>
                            <label>Destin√© √†
                                <input id="f-filter-destined" type="text" placeholder="" />
                            </label>
                        </div>
                        <div style="margin-top:12px;">
                            <label>Transf√©r√© de
                                <input id="f-filter-forwarded" type="text" placeholder="" />
                            </label>
                        </div>
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:16px;">
                            <div>
                                <div style="font-weight:600;">Debug mode</div>
                                <div class="muted" style="font-size:0.9rem;">Logs verbeux</div>
                            </div>
                            <label class="toggle">
                                <input id="f-debug" type="checkbox" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Options Recap -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid #eee; padding-bottom: 8px;">Options
                            Recap</h4>

                        <div
                            style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
                            <div>
                                <div style="font-weight:600;">Seulement Non-lus</div>
                            </div>
                            <label class="toggle">
                                <input id="f-unread" type="checkbox" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;">
                            <div>
                                <div style="font-weight:600;">Audio Actif</div>
                            </div>
                            <label class="toggle">
                                <input id="f-audio" type="checkbox" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <label>Voix
                                <select id="f-voice"
                                    style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
                                    <option value="alloy">Alloy</option>
                                    <option value="echo">Echo</option>
                                    <option value="fable">Fable</option>
                                    <option value="onyx">Onyx</option>
                                    <option value="nova">Nova</option>
                                    <option value="shimmer">Shimmer</option>
                                </select>
                            </label>
                            <label>Vitesse
                                <input id="f-speed" type="number" step="0.05" min="0.25" max="4.0" placeholder="1.0" />
                            </label>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <label>Tri
                                <select id="f-sort"
                                    style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
                                    <option value="date_desc">R√©cents d'abord</option>
                                    <option value="date_asc">Anciens d'abord</option>
                                    <option value="priority">Priorit√© IA</option>
                                </select>
                            </label>
                            <label>Langue
                                <select id="f-lang"
                                    style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
                                    <option value="fr">Fran√ßais</option>
                                    <option value="en">Anglais</option>
                                    <option value="es">Espagnol</option>
                                </select>
                            </label>
                        </div>
                        <label>Cat√©gories (s√©par√©es par virgule)
                            <input id="f-categories" type="text" placeholder="ACTION, MEETING..." />
                        </label>
                    </div>

                    <!-- Status -->
                    <div style="border-top:1px solid rgba(148,163,184,0.3); margin:16px 0; padding-top:16px;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                            <div>
                                <div style="font-weight:600;">Status Actif</div>
                                <div class="muted" style="font-size:0.9rem;">D√©sactiver pour mettre en pause</div>
                            </div>
                            <label class="toggle">
                                <input id="f-status" type="checkbox" />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:16px;">
                        <button type="button" class="btn btn-primary" id="save-settings">Enregistrer les Modifs</button>
                    </div>
                </form>
            </section>
        </div>
    </section>

    <div id="toast" class="toast">Action effectu√©e</div>

    <footer class="footer">
        <div class="container center">
            <p class="muted">¬© 2025 mial ‚Äî Admin ¬∑ <a href="/mentions-legales.html">Mentions L√©gales</a></p>
        </div>
    </footer>

    <script src="/main.js"></script>
    <script>
        // Global State
        let PROFILES_BY_ID = new Map();
        let currentProfileId = null;

        // Cache & Loading States
        const CACHE = {
            users: [],
            mailboxes: {}, // userId -> []
            profiles: {}   // mailboxId -> []
        };
        const LOADING = {
            mailboxes: {}, // userId -> bool
            profiles: {}   // mailboxId -> bool
        };

        // Nav
        const navToggle = document.querySelector('.nav-toggle');
        const nav = document.querySelector('.nav');
        if (navToggle) navToggle.addEventListener('click', () => nav.classList.toggle('nav-open'));

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await fetch('/portal-api/auth/logout', { method: 'POST', credentials: 'include' });
                window.location.href = '/login.html';
            } catch (e) {
                window.location.href = '/login.html';
            }
        });

        // Toast
        function showToast(msg, error = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.background = error ? '#ef4444' : '#333';
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 3000);
        }

        // --- MAIN INIT ---
        document.addEventListener('DOMContentLoaded', initDashboard);

        async function initDashboard() {
            // Reset Cache
            CACHE.users = [];
            CACHE.mailboxes = {};
            CACHE.profiles = {};
            document.getElementById('hierarchy-root').innerHTML = '<div style="text-align:center; padding: 40px;" class="muted">Chargement de la hi√©rarchie...</div>';

            try {
                // FEATURE DETECTION: Try Admin Tree first
                let useTree = false;
                try {
                    const treeRes = await fetch(apiUrl('/admin/api/admin-tree'), { credentials: 'include' });
                    if (treeRes.ok) {
                        const tree = await treeRes.json();
                        // Assuming tree structure: users -> mailboxes -> profiles nested
                        // If endpoint existed, we would render full tree: cache everything.
                        // For now we assume typical Users list fallback if tree API structure is complex or not actually ready.
                        // But let's assume if it returns, it is an array of users with nested arrays.
                        // Since I don't know the exact format of the hypothetical tree, I'll stick to logic:
                        // "If admin-tree endpoint does not exist, use these 3 endpoints"
                        // If it EXISTS, I use it.
                        // I will assume it returns: [ { ...user, mailboxes: [ { ...mailbox, profiles: [...] } ] } ]
                        CACHE.users = tree;
                        // Populate sub-caches? Or just render from root?
                        // Let's populate CACHE.mailboxes and CACHE.profiles if tree is deep.
                        tree.forEach(u => {
                            if (u.mailboxes) {
                                CACHE.mailboxes[u.id] = u.mailboxes;
                                u.mailboxes.forEach(m => {
                                    if (m.profiles) CACHE.profiles[m.id] = m.profiles;
                                });
                            }
                        });
                        useTree = true;
                        renderUsersRoot(tree);
                    }
                } catch (e) {
                    console.log("Admin Tree check failed or errored:", e);
                }

                if (!useTree) {
                    // Fallback to minimal user fetch
                    await fetchUsers();
                }

            } catch (e) {
                document.getElementById('hierarchy-root').innerHTML = `<div style="text-align:center; color:red; padding: 20px;">Erreur init: ${e.message}</div>`;
            }
        }

        // ---------------------------------------------
        // FALLBACK FLOW (Lazy Load)
        // ---------------------------------------------

        async function fetchUsers() {
            try {
                const res = await fetch(apiUrl('/admin/api/users'), { credentials: 'include' });
                if (!res.ok) throw new Error('Impossible de charger les utilisateurs');
                const users = await res.json();
                CACHE.users = users;
                renderUsersRoot(users);
            } catch (e) {
                document.getElementById('hierarchy-root').innerHTML = `<div style="text-align:center; color:red;">${e.message}</div>`;
            }
        }

        function renderUsersRoot(users) {
            const root = document.getElementById('hierarchy-root');
            if (!users || users.length === 0) {
                root.innerHTML = '<div style="text-align:center; padding: 20px;">Aucun utilisateur.</div>';
                return;
            }

            // Build HTML
            root.innerHTML = users.map(u => buildUserRow(u)).join('');
        }

        function buildUserRow(u) {
            const created = u.created_at ? new Date(u.created_at).toLocaleDateString() : '‚Äî';
            const activeBadge = u.is_active
                ? `<span class="badge-active">ACTIF</span>`
                : `<span class="badge-inactive">INACTIF</span>`;

            // counts (if provider by backend, else 0 or placeholder)
            // If we have cached children, we can count them.
            let mbCount = '?';
            let pfCount = '?';

            if (u.mailboxes_count !== undefined) mbCount = u.mailboxes_count;
            if (u.profiles_count !== undefined) pfCount = u.profiles_count;

            // Override with actual cache if available (for tree mode)
            if (CACHE.mailboxes[u.id]) {
                mbCount = CACHE.mailboxes[u.id].length;
                // Sum profiles
                let localPCount = 0;
                CACHE.mailboxes[u.id].forEach(m => {
                    if (CACHE.profiles[m.id]) localPCount += CACHE.profiles[m.id].length;
                });
                if (mbCount > 0) pfCount = localPCount; // Rough estimate if we have tree
            }

            return `
            <div id="user-container-${u.id}" class="user-row" style="border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px; background: white; overflow: hidden;">
                <!-- HEADER -->
                <div onclick="toggleUser('${u.id}')" style="padding: 12px 16px; background: #f8fafc; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid transparent;">
                    <div style="display:flex; align-items:center; gap: 12px;">
                        <span style="font-size: 1.2rem; transform: rotate(0deg); transition: transform 0.2s;" id="icon-user-${u.id}">‚ñ∂</span>
                        <div>
                            <div style="font-weight: 600; font-size: 1rem; color: #1e293b;">${escapeHtml(u.email)}</div>
                            <div class="muted" style="font-size: 0.8rem;">
                                ID: ${u.id.substring(0, 8)}... ¬∑ ${u.role || 'user'} ¬∑ ${created}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; align-items:center; gap: 16px;">
                         <div style="font-size: 0.85rem; color: #64748b;">
                            <span id="count-mb-${u.id}"><strong>${mbCount}</strong> Bo√Ætes</span> ¬∑ 
                            <span id="count-pf-${u.id}"><strong>${pfCount}</strong> Profils</span>
                         </div>
                         ${activeBadge}
                         <button class="action-btn" style="color: #ef4444; border-color: #fecaca; margin-left: 12px;" onclick="event.stopPropagation(); deleteUser('${u.id}')">Supprimer</button>
                    </div>
                </div>
                <!-- CONTENT -->
                <div id="content-user-${u.id}" style="display: none; border-top: 1px solid #e2e8f0;">
                    <div style="padding: 16px; background: #fff;" id="inner-user-${u.id}">
                        <!-- Mailboxes render here -->
                    </div>
                </div>
            </div>
            `;
        }

        async function toggleUser(userId) {
            const content = document.getElementById(`content-user-${userId}`);
            const icon = document.getElementById(`icon-user-${userId}`);
            const inner = document.getElementById(`inner-user-${userId}`);

            if (content.style.display === 'none') {
                // EXPAND
                content.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';

                // Fetch if not cached
                if (!CACHE.mailboxes[userId] && !LOADING.mailboxes[userId]) {
                    LOADING.mailboxes[userId] = true;
                    inner.innerHTML = '<div class="muted">Chargement des bo√Ætes...</div>';
                    try {
                        const res = await fetch(apiUrl(`/admin/api/users/${userId}/email-accounts`), { credentials: 'include' });
                        if (res.ok) {
                            const mbs = await res.json();
                            CACHE.mailboxes[userId] = mbs;
                            renderMailboxes(userId, mbs);
                        } else {
                            // Clean fallback if 404 or empty
                            inner.innerHTML = '<div class="muted" style="padding:8px;">Aucune bo√Æte mail (API Error/Empty).</div>';
                        }
                    } catch (e) {
                        inner.innerHTML = `<div style="color:red;">${e.message}</div>`;
                    } finally {
                        LOADING.mailboxes[userId] = false;
                    }
                } else if (CACHE.mailboxes[userId]) {
                    renderMailboxes(userId, CACHE.mailboxes[userId]);
                }

            } else {
                // COLLAPSE
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function renderMailboxes(userId, mailboxes) {
            const container = document.getElementById(`inner-user-${userId}`);
            if (!mailboxes || mailboxes.length === 0) {
                container.innerHTML = '<div class="muted" style="padding:8px; font-style:italic;">Aucune bo√Æte mail connect√©e.</div>';
                return;
            }

            container.innerHTML = mailboxes.map(mb => buildMailboxRow(mb)).join('');
        }

        function buildMailboxRow(mb) {
            const statusColor = (mb.status === 'connected') ? '#16a34a' : '#f59e0b'; // Assume connected vs invalid/other

            return `
            <div id="mailbox-container-${mb.id}" style="margin-top: 8px; border: 1px solid #f1f5f9; border-radius: 6px; background: #f8fafc;">
                 <div onclick="toggleMailbox('${mb.id}')" style="padding: 8px 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display:flex; align-items:center; gap: 8px;">
                        <span id="icon-mb-${mb.id}" style="font-size: 0.9rem; transition: transform 0.2s;">‚ñ∂</span>
                        <strong>${escapeHtml(mb.email_address)}</strong>
                        <span style="font-size:0.8rem; background: #e2e8f0; padding: 1px 6px; border-radius: 4px;">${mb.provider}</span>
                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; display: inline-block;"></span>
                    </div>
                    <div>
                         <button class="action-btn" style="color: #ef4444; border-color: #fecaca; font-size: 0.75rem;" onclick="event.stopPropagation(); deleteMailbox('${mb.id}', '${mb.user_id}')">Supprimer Bo√Æte</button>
                    </div>
                 </div>
                 <div id="content-mb-${mb.id}" style="display: none; padding: 12px; border-top: 1px solid #f1f5f9; background: white;">
                    <!-- Profiles Table Reuse -->
                    <table class="dashboard-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Recipient</th>
                                <th>Timezone</th>
                                <th>Heures</th>
                                <th>Jours</th>
                                <th>Status</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-mb-${mb.id}">
                             <!-- Rows go here -->
                        </tbody>
                    </table>
                 </div>
            </div>
            `;
        }

        async function toggleMailbox(mbId) {
            const content = document.getElementById(`content-mb-${mbId}`);
            const icon = document.getElementById(`icon-mb-${mbId}`);
            const tbody = document.getElementById(`tbody-mb-${mbId}`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';

                if (!CACHE.profiles[mbId] && !LOADING.profiles[mbId]) {
                    LOADING.profiles[mbId] = true;
                    tbody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;">Chargement profils...</td></tr>';
                    try {
                        const res = await fetch(apiUrl(`/admin/api/email-accounts/${mbId}/recap-profiles`), { credentials: 'include' });
                        if (res.ok) {
                            const profs = await res.json();
                            CACHE.profiles[mbId] = profs;
                            renderProfiles(mbId, profs);
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center;">Aucun profil (ou chargement impossible).</td></tr>';
                        }
                    } catch (e) {
                        tbody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">${e.message}</td></tr>`;
                    } finally {
                        LOADING.profiles[mbId] = false;
                    }
                } else if (CACHE.profiles[mbId]) {
                    renderProfiles(mbId, CACHE.profiles[mbId]);
                }

            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function renderProfiles(mbId, profiles) {
            const tbody = document.getElementById(`tbody-mb-${mbId}`);
            if (!profiles || profiles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="muted" style="text-align:center; font-style:italic;">Aucun profil de r√©cap.</td></tr>';
                return;
            }

            // Register in GLOBAL MAP for editor
            profiles.forEach(p => PROFILES_BY_ID.set(p.id, p));

            // REUSE EXACT EXISTING MARKUP
            tbody.innerHTML = profiles.map(p => {
                const status = escapeHtml(p.status ?? '‚Äî');
                // Check 'active' loosely
                const isStatusActive = (String(p.status).toLowerCase() === 'active');
                const statusClass = isStatusActive ? 'badge-active' : 'badge-inactive';
                const recipient = p.recap_recipient || '‚Äî';
                const hours = `${p.heure_debut || '‚Äî'} - ${p.heure_fin || '‚Äî'}`;
                const jours = `${p.jours_arriere_start || 0} ‚Üí ${p.jours_arriere_end || 0}`;

                // Add delete profile button in actions
                return `
                <tr id="profile-row-${p.id}">
                    <td style="font-family:monospace; font-size:0.85rem; color:#64748b;">${p.id.substring(0, 8)}...</td>
                    <td><strong>${escapeHtml(recipient)}</strong></td>
                    <td>${escapeHtml(p.timezone || '‚Äî')}</td>
                    <td>${hours}</td>
                    <td>${jours}</td>
                    <td><span class="${statusClass}">${status}</span></td>
                    <td style="text-align: right; white-space: nowrap;">
                         <button class="action-btn" onclick="openEditor('${p.id}')">√âditer / D√©tails</button>
                         <button class="action-btn" style="color:#ef4444; border-color:transparent; background:transparent;" onclick="deleteProfile('${p.id}', '${mbId}')">üóë</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // ---------------------------------------------
        // DELETION & UPDATES
        // ---------------------------------------------

        async function deleteUser(id) {
            if (!confirm("Attention: Supprimer cet utilisateur ? Toutes les donn√©es li√©es seront perdues.")) return;
            try {
                const res = await fetch(apiUrl(`/admin/api/users/${id}`), {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!res.ok) throw new Error('Delete failed');

                showToast("Utilisateur supprim√©");
                // Remove from DOM
                const row = document.getElementById(`user-container-${id}`);
                if (row) row.remove();
                // Remove from cache
                if (CACHE.users) CACHE.users = CACHE.users.filter(u => u.id !== id);

            } catch (e) {
                showToast(e.message, true);
            }
        }

        async function deleteMailbox(mbId, userId) {
            if (!confirm("Supprimer cette bo√Æte mail ?")) return;
            try {
                const res = await fetch(apiUrl(`/admin/api/email-accounts/${mbId}`), {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!res.ok) throw new Error('Delete failed');

                showToast("Bo√Æte supprim√©e");
                // Remove DOM
                const row = document.getElementById(`mailbox-container-${mbId}`);
                if (row) row.remove();

                // Update Counts UI
                const mbCountEl = document.getElementById(`count-mb-${userId}`);
                if (mbCountEl) {
                    let c = parseInt(mbCountEl.textContent.match(/\d+/)?.[0] || '0');
                    if (c > 0) mbCountEl.innerHTML = `<strong>${c - 1}</strong> Bo√Ætes`;
                }

                // Also update profile count if we can? 
                if (CACHE.profiles[mbId]) {
                    const lostProfiles = CACHE.profiles[mbId].length;
                    const pfCountEl = document.getElementById(`count-pf-${userId}`);
                    if (pfCountEl) {
                        let c = parseInt(pfCountEl.textContent.match(/\d+/)?.[0] || '0');
                        if (c >= lostProfiles) pfCountEl.innerHTML = `<strong>${c - lostProfiles}</strong> Profils`;
                    }
                }

                // Update Cache
                if (CACHE.mailboxes[userId]) {
                    CACHE.mailboxes[userId] = CACHE.mailboxes[userId].filter(m => m.id !== mbId);
                }

            } catch (e) {
                showToast(e.message, true);
            }
        }

        async function deleteProfile(pId, mbId) {
            if (!confirm("Supprimer ce profil ?")) return;
            try {
                const res = await fetch(apiUrl(`/admin/api/recap-profiles/${pId}`), {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!res.ok) throw new Error('Delete failed');

                showToast("Profil supprim√©");
                const row = document.getElementById(`profile-row-${pId}`);
                if (row) row.remove();

                // Find user ID from mailbox reversed lookup or just iterate DOM if lazy
                const mbRow = document.getElementById(`mailbox-container-${mbId}`);
                const userRow = mbRow ? mbRow.closest('.user-row') : null;

                if (userRow) {
                    const userId = userRow.id.replace('user-container-', '');
                    const pfCountEl = document.getElementById(`count-pf-${userId}`);
                    if (pfCountEl) {
                        let c = parseInt(pfCountEl.textContent.match(/\d+/)?.[0] || '0');
                        if (c > 0) pfCountEl.innerHTML = `<strong>${c - 1}</strong> Profils`;
                    }
                }

                // Update Cache
                if (CACHE.profiles[mbId]) {
                    CACHE.profiles[mbId] = CACHE.profiles[mbId].filter(p => p.id !== pId);
                }

            } catch (e) {
                showToast(e.message, true);
            }
        }


        // ---------------------------------------------
        // EDITOR LOGIC (EXISTING REUSED)
        // ---------------------------------------------

        function openEditor(id) {
            const p = PROFILES_BY_ID.get(id);
            if (!p) return;
            currentProfileId = id;
            document.getElementById('edit-profile-id').textContent = id;

            // Reset msgs
            document.getElementById('editor-error').style.display = 'none';
            document.getElementById('editor-ok').style.display = 'none';

            // Show
            const editorData = document.getElementById('profile-editor');
            editorData.style.display = 'block';

            // Fill Fields
            document.getElementById('f-timezone').value = p.timezone || '';
            document.getElementById('f-start').value = p.heure_debut || '';
            document.getElementById('f-end').value = p.heure_fin || '';
            document.getElementById('f-days-start').value = p.jours_arriere_start ?? 0;
            document.getElementById('f-days-end').value = p.jours_arriere_end ?? 0;
            document.getElementById('f-debug').checked = (p.debug_mode === true);

            const f = p.filters || {};
            const arrToCsv = (a) => Array.isArray(a) ? a.join(', ') : '';
            document.getElementById('f-filter-sender').value = arrToCsv(f.sender);
            document.getElementById('f-filter-exclude').value = arrToCsv(f.exclude);
            document.getElementById('f-filter-cc').value = arrToCsv(f.cc);
            document.getElementById('f-filter-destined').value = arrToCsv(f.destined_to);
            document.getElementById('f-filter-forwarded').value = arrToCsv(f.forwarded_from);

            document.getElementById('f-unread').checked = (p.only_unread === true);
            document.getElementById('f-audio').checked = (p.audio_actif === true);
            document.getElementById('f-voice').value = p.voice || 'alloy';
            document.getElementById('f-speed').value = p.speed || 1.0;
            document.getElementById('f-sort').value = p.sort_mode || 'date_desc';
            document.getElementById('f-lang').value = p.language || 'fr';
            document.getElementById('f-categories').value = p.categories || '';

            const st = String(p.status ?? '').toLowerCase();
            document.getElementById('f-status').checked = (st === 'active');

            // Assignment block
            const assignEmailInput = document.getElementById('f-assign-email');
            const unassignBtn = document.getElementById('btn-unassign');
            const assignStatus = document.getElementById('assign-status');

            if (p.assigned_to_email) {
                assignEmailInput.value = p.assigned_to_email;
                unassignBtn.style.display = 'inline-block';
                assignStatus.textContent = `Assign√© √† : ${p.assigned_to_email}`;
            } else {
                assignEmailInput.value = '';
                unassignBtn.style.display = 'none';
                assignStatus.textContent = "Non assign√© (Orphelin)";
            }

            editorData.scrollIntoView({ behavior: 'smooth' });
        }

        // Editor Listeners
        const closeBtn = document.getElementById('editor-close');
        if (closeBtn) closeBtn.addEventListener('click', () => {
            document.getElementById('profile-editor').style.display = 'none';
            currentProfileId = null;
        });

        // SAVE
        const saveBtn = document.getElementById('save-settings');
        if (saveBtn) saveBtn.addEventListener('click', async () => {
            if (!currentProfileId) return;
            const errDiv = document.getElementById('editor-error');
            const okDiv = document.getElementById('editor-ok');
            errDiv.style.display = 'none';
            okDiv.style.display = 'none';

            // Validate time
            const normalizeTime = (t) => {
                if (!t) return null;
                const m = t.match(/^(\d{1,2}):(\d{2})$/);
                if (m) return `${m[1].padStart(2, '0')}:${m[2]}:00`;
                return t.length === 8 ? t : null;
            };

            const tz = document.getElementById('f-timezone').value.trim();
            const cleanStart = normalizeTime(document.getElementById('f-start').value);
            const cleanEnd = normalizeTime(document.getElementById('f-end').value);

            if (!tz) { errDiv.innerText = "Timezone requise"; errDiv.style.display = 'block'; return; }
            if (!cleanStart || !cleanEnd) { errDiv.innerText = "Heures invalides"; errDiv.style.display = 'block'; return; }

            const csvToArr = (s) => s.split(',').map(x => x.trim()).filter(x => x.length > 0);

            const payload = {
                timezone: tz,
                heure_debut: cleanStart,
                heure_fin: cleanEnd,
                jours_arriere_start: parseInt(document.getElementById('f-days-start').value) || 0,
                jours_arriere_end: parseInt(document.getElementById('f-days-end').value) || 0,
                debug_mode: document.getElementById('f-debug').checked,
                status: document.getElementById('f-status').checked ? 'Active' : 'Inactive',
                filters: {
                    sender: csvToArr(document.getElementById('f-filter-sender').value),
                    exclude: csvToArr(document.getElementById('f-filter-exclude').value),
                    cc: csvToArr(document.getElementById('f-filter-cc').value),
                    destined_to: csvToArr(document.getElementById('f-filter-destined').value),
                    forwarded_from: csvToArr(document.getElementById('f-filter-forwarded').value)
                },
                only_unread: document.getElementById('f-unread').checked,
                audio_actif: document.getElementById('f-audio').checked,
                voice: document.getElementById('f-voice').value,
                speed: parseFloat(document.getElementById('f-speed').value),
                sort_mode: document.getElementById('f-sort').value,
                language: document.getElementById('f-lang').value,
                categories: document.getElementById('f-categories').value.trim()
            };

            try {
                const res = await fetch(apiUrl(`/profiles/${currentProfileId}/settings`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(await res.text());

                okDiv.textContent = "Sauvegard√© !";
                okDiv.style.display = 'block';
                // REFRESH LOCAL MAP
                Object.assign(PROFILES_BY_ID.get(currentProfileId), payload);
                // Also update UI row if visible
                const p = PROFILES_BY_ID.get(currentProfileId);
                const row = document.getElementById(`profile-row-${p.id}`);
                if (row) {
                    // Quick dirty update of status/time cell content if we wanted.
                    // But simpler to just let user expand/collapse to refresh if they care.
                    // Or just leave it.
                }

            } catch (e) {
                errDiv.textContent = "Erreur: " + e.message;
                errDiv.style.display = 'block';
            }
        });

        // DELETE Profile (Connected to editor button)
        const btnDel = document.getElementById('btn-delete-profile');
        if (btnDel) btnDel.addEventListener('click', async () => {
            if (!currentProfileId) return;
            if (!confirm("Vraiment supprimer ce profil ?")) return;
            try {
                const res = await fetch(apiUrl(`/admin/api/recap-profiles/${currentProfileId}`), { method: 'DELETE', credentials: 'include' });
                if (!res.ok) throw new Error(await res.text());

                showToast("Profil supprim√©");
                document.getElementById('profile-editor').style.display = 'none';

                // Remove from UI
                const pId = currentProfileId;
                const row = document.getElementById(`profile-row-${pId}`);
                if (row) {
                    // Try to find mailbox ID to update counts
                    const mbRow = row.closest('[id^="mailbox-container-"]');
                    if (mbRow) {
                        const mbId = mbRow.id.replace('mailbox-container-', '');
                        // Just trigger deleteProfile logic which updates UI
                        const delSuccess = true; // we already deleted via API
                        row.remove();
                        // Update cache
                        if (CACHE.profiles[mbId]) CACHE.profiles[mbId] = CACHE.profiles[mbId].filter(p => p.id !== pId);

                        // Update User Counts
                        const userRow = mbRow.closest('.user-row');
                        if (userRow) {
                            const userId = userRow.id.replace('user-container-', '');
                            const pfCountEl = document.getElementById(`count-pf-${userId}`);
                            if (pfCountEl) {
                                let c = parseInt(pfCountEl.textContent.match(/\d+/)?.[0] || '0');
                                if (c > 0) pfCountEl.innerHTML = `<strong>${c - 1}</strong> Profils`;
                            }
                        }
                    }
                }

                currentProfileId = null;
            } catch (e) {
                showToast("Erreur suppression: " + e.message, true);
            }
        });

        // ASSIGN
        const btnAssign = document.getElementById('btn-assign');
        if (btnAssign) btnAssign.addEventListener('click', async () => {
            if (!currentProfileId) return;
            const email = document.getElementById('f-assign-email').value.trim();
            if (!email) return alert("Email requis");
            try {
                const res = await fetch(apiUrl('/admin/assign'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profile_id: currentProfileId, user_email: email }),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(await res.text());
                showToast("Assign√© avec succ√®s");
                setTimeout(() => openEditor(currentProfileId), 500);
            } catch (e) { showToast(e.message, true); }
        });

        // DESASSIGN
        const btnUnassign = document.getElementById('btn-unassign');
        if (btnUnassign) btnUnassign.addEventListener('click', async () => {
            if (!currentProfileId) return;
            if (!confirm("Retirer l'assignation ?")) return;
            try {
                const res = await fetch(apiUrl(`/admin/assign/${currentProfileId}`), { method: 'DELETE', credentials: 'include' });
                if (!res.ok) throw new Error(await res.text());
                showToast("D√©sassign√©");
                setTimeout(() => openEditor(currentProfileId), 500);
            } catch (e) { showToast(e.message, true); }
        });

        function escapeHtml(s) {
            return String(s ?? '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
        }
    </script>
</body>

</html>