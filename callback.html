<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Connexion en cours...</title>
    <link rel="icon" type="image/svg+xml" href="/assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="/style.css">
    <script src="/api.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3TS6HMSLCK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-3TS6HMSLCK');
    </script>
</head>

<body
    style="display:flex; align-items:center; justify-content:center; height:100vh; flex-direction:column; background:#f8fafc;">

    <div class="card glass-static center" style="padding:40px; max-width:400px; width:100%;">
        <div id="loading-state">
            <div class="loader"
                style="margin: 0 auto 20px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">
            </div>
            <h3>Connexion à Microsoft...</h3>
            <p class="muted">Nous finalisons la configuration de votre compte. Veuillez patienter.</p>
        </div>

        <div id="error-state" style="display:none; text-align:center;">
            <div style="font-size:3rem; margin-bottom:16px;">⚠️</div>
            <h3 style="color:#ef4444; margin-bottom:8px;">Erreur de connexion</h3>
            <p id="error-msg" class="muted" style="margin-bottom:24px;">Une erreur est survenue.</p>
            <a href="/onboarding.html" class="btn btn-primary">Retour</a>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script>
        (async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            const showErr = (msg) => {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-msg').textContent = msg;
            };

            if (error) {
                showErr("Microsoft a refusé la connexion ou une erreur est survenue: " + error);
                return;
            }

            if (!code) {
                showErr("Code d'autorisation manquant. Veuillez réessayer.");
                return;
            }

            try {
                // Exchange code
                // IMPORTANT: redirect_uri must match exactly what was sent in step 1
                const redirectUri = window.location.origin + '/callback.html';

                const res = await fetch(apiUrl('/auth/microsoft/exchange'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, redirect_uri: redirectUri }),
                    credentials: 'include'
                });

                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(txt || 'Erreur serveur');
                }

                // Success
                window.location.href = '/dashboard.html?success=outlook_connected';

            } catch (e) {
                console.error(e);
                showErr("Echec de la validation: " + e.message);
            }
        })();
    </script>
</body>

</html>