<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mial Vocal</title>
    <link rel="icon" type="image/svg+xml" href="assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1fb6ff">
</head>

<body>
    <header id="site-header" class="nav">
        <div class="container nav-container">
            <a href="dashboard.html" class="nav-logo"
                style="text-decoration:none; display:flex; align-items:center; gap:8px;">
                <span style="font-size:1.2rem;">‚úï</span>
                <span style="font-weight:700;">Mial Vocal</span>
            </a>

            <div class="vocal-header-actions">
                <button class="btn btn-ghost btn-icon" onclick="openSettings()" title="Param√®tres">
                    ‚öôÔ∏è
                </button>
            </div>
        </div>
    </header>

    <section class="section" style="padding-top: 100px; min-height: 100vh; display:flex; align-items:center;">
        <div class="container">
            <div class="card glass-static"
                style="padding: 40px 20px; min-height: 60vh; display:flex; flex-direction:column; justify-content:center;">

                <div id="native-interface" class="vocal-container">
                    <button id="main-mic" class="mic-btn idle" onclick="toggleVocalSession()">
                        üéôÔ∏è
                    </button>
                    <div id="status-display" class="vocal-status">Appuyez pour d√©marrer</div>
                    <div id="transcript-display" class="vocal-transcript"></div>
                </div>

            </div>
        </div>
    </section>

    <div id="settings-modal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:200; align-items:center; justify-content:center;">
        <div class="card"
            style="width:90%; max-width:600px; max-height:90vh; overflow-y:auto; padding:0; background:#fff;">

            <div
                style="padding:20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:#fff; z-index:10;">
                <h3 style="margin:0;">Configuration Vocal</h3>
                <button class="btn btn-ghost" onclick="closeSettings()" style="color:#ef4444;">Fermer</button>
            </div>

            <div style="padding:24px;">
                <form id="form-vocal-config">
                    <div class="editor-section">
                        <h4 class="editor-title">üìÖ P√©riode</h4>
                        <label class="form-label">Analyser depuis (Heures)</label>
                        <select id="v-hours" class="form-select" style="width:100%;">
                            <option value="12">12 heures</option>
                            <option value="24" selected>24 heures</option>
                            <option value="48">48 heures</option>
                            <option value="72">3 jours</option>
                        </select>
                    </div>

                    <div class="editor-section">
                        <h4 class="editor-title">üß† Filtres</h4>

                        <div style="margin-bottom:16px;">
                            <label class="form-label">Mode de Tri</label>
                            <select id="v-sort" class="form-select" style="width:100%;">
                                <option value="priority">Priorit√© IA (Urgent d'abord)</option>
                                <option value="date_desc">Chronologique</option>
                            </select>
                        </div>

                        <div
                            style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:10px; margin-bottom:10px;">
                            <div><strong>Ignorer les pubs</strong></div>
                            <label class="toggle-wrapper">
                                <input type="checkbox" id="v-marketing" class="toggle-input" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div
                            style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:10px;">
                            <div><strong>Seulement non-lus</strong></div>
                            <label class="toggle-wrapper">
                                <input type="checkbox" id="v-unread" class="toggle-input">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="editor-section">
                        <h4 class="editor-title">üó£Ô∏è Voix</h4>
                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                            <div>
                                <label class="form-label">Voix IA</label>
                                <select id="v-voice" class="form-select" style="width:100%;">
                                    <option value="nova" selected>Nova (Femme)</option>
                                    <option value="onyx">Onyx (Homme)</option>
                                    <option value="alloy">Alloy (Neutre)</option>
                                    <option value="shimmer">Shimmer (Calme)</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Vitesse</label>
                                <select id="v-speed" class="form-select" style="width:100%;">
                                    <option value="1.0">1.0x</option>
                                    <option value="1.1">1.1x</option>
                                    <option value="1.2">1.2x</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div style="padding:20px; border-top:1px solid #e2e8f0; text-align:right; background:#f8fafc;">
                <button class="btn btn-primary" onclick="closeSettings()">Valider</button>
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // --- LOGIQUE JS ---

        let SESSION_ACTIVE = false;
        let PROFILE_ID = null;
        let CURRENT_EMAIL_ID = null;

        // 1. Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            // Charger le profil par d√©faut
            try {
                const res = await fetch(apiUrl('/my/profiles'), { credentials: 'include' });
                if (res.status === 401) window.location.href = 'Connexion.html';
                const profiles = await res.json();
                if (profiles.length > 0) PROFILE_ID = profiles[0].id;
            } catch (e) { console.error(e); }
        });

        // 2. Gestion Param√®tres
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

        // 3. Lancer la Session
        async function toggleVocalSession() {
            if (SESSION_ACTIVE) return; // Stop logic later
            if (!PROFILE_ID) { alert("Profil introuvable."); return; }

            SESSION_ACTIVE = true;
            const btn = document.getElementById('main-mic');
            const status = document.getElementById('status-display');

            // √âtat: Analyse en cours
            btn.className = 'mic-btn processing';
            status.textContent = "Analyse de vos emails...";

            // R√©cup√©rer la config du formulaire
            const config = {
                hours_back: document.getElementById('v-hours').value,
                voice: document.getElementById('v-voice').value,
                speed: document.getElementById('v-speed').value,
                // On pourrait envoyer plus de filtres ici
                state: 'start',
                profile_id: PROFILE_ID
            };

            // D√©marrer la boucle (Start -> Analyse -> Intro Audio)
            startLoop(config);
        }

        async function startLoop(data) {
            const status = document.getElementById('status-display');
            const btn = document.getElementById('main-mic');

            try {
                // Pr√©parer FormData (pour envoyer fichier audio + json)
                let fd = new FormData();
                for (let key in data) fd.append(key, data[key]);

                // Appel API
                const res = await fetch(apiUrl('/vocal/interact'), {
                    method: 'POST', body: fd, credentials: 'include'
                });

                if (res.headers.get("X-Action") === "stop") {
                    // Fin de session
                    const blob = await res.blob();
                    await playAudio(blob);
                    resetUI();
                    status.textContent = "Termin√©.";
                    return;
                }

                // ID du mail en cours
                CURRENT_EMAIL_ID = res.headers.get("X-Current-Email-ID");

                // 1. JOUER L'AUDIO (IA Parle)
                btn.className = 'mic-btn playing';
                status.textContent = "Mial parle...";
                const audioBlob = await res.blob();
                await playAudio(audioBlob);

                // 2. √âCOUTER (Micro on)
                btn.className = 'mic-btn recording';
                status.textContent = "√Ä vous...";
                const userAudio = await recordAudio(4000); // 4 sec d'√©coute

                // 3. BOUCLER
                btn.className = 'mic-btn processing';
                status.textContent = "R√©flexion...";

                startLoop({
                    profile_id: PROFILE_ID,
                    state: 'listening_action',
                    current_email_id: CURRENT_EMAIL_ID,
                    file: userAudio // Le fichier sera g√©r√© par FormData
                });

            } catch (e) {
                console.error(e);
                status.textContent = "Erreur: " + e.message;
                resetUI();
            }
        }

        // --- HELPERS AUDIO ---
        function playAudio(blob) {
            return new Promise(resolve => {
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.onended = resolve;
                audio.play();
            });
        }

        function recordAudio(ms) {
            return new Promise(async (resolve) => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const rec = new MediaRecorder(stream);
                    const chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);
                    rec.onstop = () => resolve(new Blob(chunks, { type: 'audio/webm' }));
                    rec.start();
                    setTimeout(() => rec.stop(), ms);
                } catch (e) {
                    alert("Micro requis !");
                    resolve(null);
                }
            });
        }

        function resetUI() {
            SESSION_ACTIVE = false;
            document.getElementById('main-mic').className = 'mic-btn idle';
            document.getElementById('status-display').textContent = "Appuyez pour d√©marrer";
        }
    </script>
</body>

</html>