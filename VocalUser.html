<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mial Vocal — mial</title>
    <link rel="icon" type="image/svg+xml" href="assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1fb6ff">
    <style>
        .vocal-frame {
            width: 100%;
            height: 100%;
            border: none;
            min-height: 75vh;
            display: block;
        }
    </style>
</head>

<body>
    <header id="site-header" class="nav">
        <div id="header-placeholder"></div>
    </header>

    <section class="section" style="padding-top: 140px; min-height: 100vh;">
        <div class="container">
            <div class="card glass-static" style="padding: 0; overflow: hidden; height: 75vh; position: relative;">
                <!-- Iframe pointing to the local python server running vocal.py via Nginx Proxy -->
                <iframe src="/vocal-api/" class="vocal-frame" title="Interface Vocal"></iframe>

                <!-- Fallback / Helper message overlay (visible if iframe fails or is empty initially) -->
                <div id="iframe-helper"
                    style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; z-index:-1; width:80%;">
                    <p class="muted">Chargement de l'interface vocale...</p>
                    <p style="font-size:0.8rem; color:#94a3b8;">Si le chargement est bloqué (logo stop),
                        <a href="/vocal-api/" target="_blank" style="text-decoration:underline; color:#94a3b8;">cliquez
                            ici pour ouvrir dans un nouvel onglet</a>.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>
    <script src="api.js"></script>
    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch User Session from Main Portal API
                const res = await fetch(apiUrl('/me'), { credentials: 'include' });
                if (res.status === 401) {
                    window.location.href = '/Connexion.html';
                    return;
                }
                const user = await res.json();
                console.log("Mial Vocal User detected:", user.email);

                // Update Iframe Source with Email Context
                const iframe = document.querySelector('iframe.vocal-frame');
                if (iframe && user.email) {
                    // Pass email as query param so vocal.py can render it
                    iframe.src = `/vocal-api/?email=${encodeURIComponent(user.email)}`;
                }
            } catch (e) {
                console.error("Error checking session:", e);
                // Fallback: let iframe load default (it might show login button)
            }
        });
    </script>
</body>

</html>