<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Assistant Vocal — mial</title>
    <link rel="icon" type="image/svg+xml" href="assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1fb6ff">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3TS6HMSLCK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-3TS6HMSLCK');
    </script>
</head>

<body>

    <header id="site-header" class="nav">
        <div id="header-placeholder"></div>
    </header>

    <section class="section" style="padding-top: 100px; min-height: 85vh; display:flex; align-items:center;">
        <div class="container">

            <div class="card glass-static" style="padding: 40px; max-width: 600px; margin: 0 auto; text-align:center;">

                <div style="margin-bottom: 30px;">
                    <span class="vocal-user-info" id="user-display">Chargement...</span>
                </div>

                <style>
                    /* TRANSITIONS BACKGROUND (Effet Pièces Coulissantes) */
                    body {
                        /* Dégradé large : [RECAP (Rose)] --- [ACCUEIL (Neutre)] --- [AGENT (Bleu Nuit)] */
                        background: linear-gradient(90deg, #fff1f2 10%, #f8fafc 50%, #0f172a 90%);
                        background-size: 300% 100%;
                        background-position: 50% 0;
                        /* Position Initiale : CENTRE */
                        transition: background-position 1.2s cubic-bezier(0.4, 0.0, 0.2, 1), color 0.5s ease;
                        min-height: 100vh;
                    }

                    /* Pièce de Gauche : RECAP */
                    body.theme-recap {
                        background-position: 0% 0 !important;
                    }

                    /* Pièce de Droite : AGENT */
                    body.theme-agent {
                        background-position: 100% 0 !important;
                        color: white !important;
                    }

                    body.theme-agent .card.glass-static {
                        background: rgba(255, 255, 255, 0.05) !important;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        backdrop-filter: blur(10px);
                    }

                    body.theme-agent .vocal-user-info {
                        color: #bfdbfe !important;
                    }

                    body.theme-agent .vocal-status {
                        color: #93c5fd !important;
                    }

                    body.theme-agent .vocal-user-info {
                        color: #bfdbfe !important;
                    }

                    body.theme-agent .vocal-status {
                        color: #93c5fd !important;
                    }

                    /* MICRO MODERNE STYLE (Mial Live) */
                    .mic-wrapper {
                        position: relative;
                        width: 120px;
                        height: 120px;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        cursor: pointer;
                        transition: transform 0.2s ease;
                        margin: 0 auto;
                    }

                    .mic-wrapper:hover {
                        transform: scale(1.05);
                    }

                    .mic-button {
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #0ea5e9, #2563eb);
                        box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.4);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 2;
                        position: relative;
                        border: none;
                        outline: none;
                        cursor: pointer;
                    }

                    .mic-button svg {
                        width: 32px;
                        height: 32px;
                        fill: white;
                        stroke: none;
                    }

                    .ripple {
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        border-radius: 50%;
                        background: rgba(14, 165, 233, 0.3);
                        opacity: 0;
                        z-index: 1;
                        transform: scale(0.8);
                        pointer-events: none;
                    }

                    /* Etats d'animation */
                    .mic-wrapper.is-listening .ripple {
                        animation: ripple-anim 2s infinite;
                    }

                    .mic-wrapper.is-listening .ripple:nth-child(1) {
                        animation-delay: 0s;
                    }

                    .mic-wrapper.is-listening .ripple:nth-child(2) {
                        animation-delay: 0.5s;
                    }

                    .mic-wrapper.is-listening .ripple:nth-child(3) {
                        animation-delay: 1.0s;
                    }

                    @keyframes ripple-anim {
                        0% {
                            transform: scale(0.8);
                            opacity: 0.6;
                        }

                        100% {
                            transform: scale(2.0);
                            opacity: 0;
                        }
                    }

                    /* Override status classes for the inner button if needed */
                    .mic-button.recording {
                        background: linear-gradient(135deg, #ef4444, #b91c1c);
                        box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.4);
                    }

                    .mic-button.processing {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                    }

                    .mic-button.playing {
                        background: linear-gradient(135deg, #10b981, #059669);
                    }
                </style>

                <div class="vocal-container" style="min-height:auto;">
                    <!-- NOUVEAU MICRO -->
                    <div class="mic-wrapper" id="micWrapper" onclick="toggleVocalSession()">
                        <div class="ripple"></div>
                        <div class="ripple"></div>
                        <div class="ripple"></div>
                        <button class="mic-button" id="main-mic">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                <path
                                    d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                            </svg>
                        </button>
                    </div>

                    <div id="status-display" class="vocal-status">Appuyez pour parler</div>
                    <div id="actionFeedback" style="
                        margin-top: 15px; 
                        font-size: 1.1rem; 
                        color: #0ea5e9; 
                        font-weight: 700; 
                        min-height: 24px; 
                        opacity: 0;
                        transition: opacity 0.5s ease;
                        text-shadow: 0 0 15px rgba(14,165,233, 0.3);">
                    </div>
                    <div id="transcript-display" style="color:var(--muted); min-height:1.2em;"></div>
                </div>

                <div style="margin-top: 40px;">
                    <button class="btn btn-secondary" onclick="openSettings()">
                        ⚙️ Paramètres du Vocal
                    </button>
                </div>

            </div>
        </div>
    </section>

    <div id="settings-modal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(5px); z-index:200; align-items:center; justify-content:center;">

        <div
            style="width:100%; max-width:900px; max-height:95vh; overflow-y:auto; background:#fff; border-radius:16px; margin:20px;">

            <div
                style="padding:24px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; background:#fff; z-index:10;">
                <h2 style="margin:0;">Configuration Vocal</h2>
                <button class="btn btn-ghost" onclick="closeSettings()" style="color:#ef4444;">Fermer</button>
            </div>

            <div style="padding:24px;">
                <form id="form-editor">
                    <input type="hidden" id="f-account">

                    <div class="editor-section" style="display:none;">
                        <h3 class="editor-title">1. Informations Principales</h3>
                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                            <div>
                                <label class="form-label">Destinataire</label>
                                <input type="email" id="f-recipient" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Heure</label>
                                <input type="time" id="f-schedule" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="editor-section">
                        <h3 class="editor-title">2. Période Analysée</h3>
                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                            <div class="time-block">
                                <h4>DÉBUT (De quand ?)</h4>
                                <div style="display:flex; gap:12px;">
                                    <div style="flex:1">
                                        <label class="form-label" style="font-size:0.8rem">Jours arrière</label>
                                        <input type="number" id="f-days-start" class="form-input" value="1" min="0"
                                            max="30">
                                    </div>
                                    <div style="flex:1">
                                        <label class="form-label" style="font-size:0.8rem">Heure</label>
                                        <input type="time" id="f-time-start" class="form-input" value="00:00">
                                    </div>
                                </div>
                            </div>
                            <div class="time-block" style="opacity:0.5; pointer-events:none;">
                                <h4>FIN (Automatique : Maintenant)</h4>
                                <div style="display:flex; gap:12px;">
                                    <div style="flex:1">
                                        <label class="form-label" style="font-size:0.8rem">Jours arrière</label>
                                        <input type="number" id="f-days-end" class="form-input" value="0" disabled>
                                    </div>
                                    <div style="flex:1">
                                        <label class="form-label" style="font-size:0.8rem">Heure</label>
                                        <input type="time" id="f-time-end" class="form-input" value="23:59" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="editor-section">
                        <h3 class="editor-title">3. Filtres & Intelligence</h3>
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                            <label class="form-label" style="margin:0;">Mode de Tri</label>
                            <select id="f-sort" class="form-select" style="width:220px;">
                                <option value="date_desc">Chronologique (Classique)</option>
                                <option value="priority">Priorité IA (Urgent d'abord)</option>
                                <option value="category">Par Catégorie (Sujet)</option>
                            </select>
                        </div>

                        <div style="margin-bottom:16px;">
                            <label class="form-label">Whitelist (De qui ?)</label>
                            <div class="chip-container" id="container-sender">
                                <input type="text" class="chip-input" placeholder="Ajouter un email...">
                            </div>
                            <textarea id="f-filtre-sender" style="display:none;"></textarea>
                        </div>

                        <div style="margin-bottom:16px;">
                            <label class="form-label">Blacklist (Ignorer)</label>
                            <div class="chip-container" id="container-exclude">
                                <input type="text" class="chip-input" placeholder="Ajouter un email...">
                            </div>
                            <textarea id="f-exclude-sender" style="display:none;"></textarea>
                        </div>

                        <div
                            style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:10px;">
                            <div>
                                <div style="font-weight:600; font-size:0.95rem;">Ignorer les emails déjà lus</div>
                            </div>
                            <label class="toggle-wrapper">
                                <input type="checkbox" id="f-unread" class="toggle-input">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div
                            style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:10px; margin-top:12px;">
                            <div>
                                <div style="font-weight:600; font-size:0.95rem;">Cacher les Pubs & Newsletters (IA)
                                </div>
                            </div>
                            <label class="toggle-wrapper">
                                <input type="checkbox" id="f-marketing" class="toggle-input" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="editor-section">
                        <h3 class="editor-title">4. Audio & Synthèse</h3>
                        <div class="grid-2"
                            style="display:grid; grid-template-columns:1fr 1fr; gap:24px; align-items:start;">
                            <div>
                                <label class="form-label">Voix IA</label>
                                <select id="f-voice" class="form-select">
                                    <option value="alloy">Alloy (Neutre)</option>
                                    <option value="echo">Echo (Masculin Doux)</option>
                                    <option value="fable">Fable (Narratif)</option>
                                    <option value="onyx">Onyx (Masculin Profond)</option>
                                    <option value="nova">Nova (Féminin Énergique)</option>
                                    <option value="shimmer">Shimmer (Calme)</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Vitesse</label>
                                <input type="range" id="f-speed" min="0.5" max="2.0" step="0.1" value="1.0"
                                    oninput="document.getElementById('speed-val').innerText = this.value + 'x'"
                                    style="margin-bottom:16px;">
                                <div style="text-align:right; color:var(--blue);" id="speed-val">1.0x</div>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
                        <button type="button" class="btn btn-ghost" onclick="closeSettings()">Fermer</button>
                        <button type="button" class="btn btn-primary" onclick="applySettings()">Valider pour cette
                            session</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="api.js"></script>
    <script src="main.js"></script>
    <script>
        // --- LOGIQUE VOCAL USER ---

        let SESSION_ACTIVE = false;
        let PROFILE_ID = null;
        let CURRENT_EMAIL_ID = null;
        let GLOBAL_AUDIO = null;
        let NEXT_STATE = 'listening_action';
        let CONTEXT_DATA = null;

        // Configuration temporaire (valeurs par défaut)
        let VOCAL_CONFIG = {
            days_start: 1,
            time_start: "00:00",
            sort: "priority",
            whitelist: "",
            blacklist: "",
            unread: false,
            marketing: true,
            voice: "nova",
            speed: 1.0
        };

        // 1. Init
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Session Check
                const res = await fetch(apiUrl('/me'), { credentials: 'include' });
                if (res.status === 401) { window.location.href = 'Connexion.html'; return; }
                const user = await res.json();
                document.getElementById('user-display').textContent = `Connecté en tant que ${user.email}`;

                // Load Profile ID (Default First)
                const resProf = await fetch(apiUrl('/my/profiles'), { credentials: 'include' });
                const profiles = await resProf.json();
                if (profiles.length > 0) {
                    PROFILE_ID = profiles[0].id;
                    // TODO: Charger les valeurs du profil dans le formulaire pour pré-remplir
                } else {
                    alert("Veuillez créer un profil de récap d'abord.");
                }
            } catch (e) { console.error(e); }
        });

        // 2. Settings UI
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

        function applySettings() {
            // On capture les valeurs du formulaire HTML complexe
            VOCAL_CONFIG.days_start = document.getElementById('f-days-start').value;
            VOCAL_CONFIG.time_start = document.getElementById('f-time-start').value;
            VOCAL_CONFIG.sort = document.getElementById('f-sort').value;
            VOCAL_CONFIG.whitelist = document.getElementById('f-filtre-sender').value; // Chip input hidden value
            VOCAL_CONFIG.blacklist = document.getElementById('f-exclude-sender').value;
            VOCAL_CONFIG.unread = document.getElementById('f-unread').checked;
            VOCAL_CONFIG.marketing = document.getElementById('f-marketing').checked;
            VOCAL_CONFIG.voice = document.getElementById('f-voice').value;
            VOCAL_CONFIG.speed = document.getElementById('f-speed').value;

            closeSettings();
            alert("Paramètres appliqués pour le prochain lancement vocal.");
        }

        // 3. Start Session
        async function toggleVocalSession() {
            // STOP AGENT TRIGGER
            if (isAgentActive) {
                stopAgentSession();
                return;
            }

            // PAUSE / RESUME TRIGGER (Existing Logic)
            if (SESSION_ACTIVE && GLOBAL_AUDIO) {
                if (GLOBAL_AUDIO.paused) {
                    GLOBAL_AUDIO.play();
                    updateUI('playing', "Lecture...");
                } else {
                    GLOBAL_AUDIO.pause();
                    updateUI('paused', "Pause (Appuyez pour reprendre)");
                }
                return;
            }

            if (SESSION_ACTIVE) return;
            if (!PROFILE_ID) return;

            SESSION_ACTIVE = true;
            updateUI('processing', "Analyse en cours...");

            // Construction du Payload
            let config = {
                profile_id: PROFILE_ID,
                state: 'init_choice', // CHANGEMENT MAJEUR : ON COMMENCE PAR LE CHOIX
                // Paramètres du formulaire
                days_back: VOCAL_CONFIG.days_start,
                voice: VOCAL_CONFIG.voice,
                speed: VOCAL_CONFIG.speed,
                sort: VOCAL_CONFIG.sort,
                filter_marketing: VOCAL_CONFIG.marketing,
                filter_sender: VOCAL_CONFIG.whitelist,
                // FORCE TIME END = NOW
                time_end: "NOW"
            };

            await startLoop(config);
        }

        // Helper pour décoder le Base64 en Blob audio
        function base64ToBlob(base64, mimeType) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new Blob([bytes], { type: mimeType });
        }

        async function startLoop(data) {
            try {
                let fd = new FormData();
                for (let key in data) fd.append(key, data[key]);

                const res = await fetch(apiUrl('/vocal/interact'), {
                    method: 'POST', body: fd, credentials: 'include'
                });

                // PROTOCOLE JSON/BASE64 (Compatible Android)
                const jsonResponse = await res.json();

                const action = jsonResponse.action;
                const feedback = jsonResponse.feedback;
                const currentEmailId = jsonResponse.current_email_id;
                const audioBase64 = jsonResponse.audio_base64;

                // --- GESTION REDIRECTION (Agent Mial) ---
                if (action === "redirect") {
                    if (feedback) {
                        const fbDiv = document.getElementById("actionFeedback");
                        if (fbDiv) { fbDiv.innerText = feedback; fbDiv.style.opacity = 1; }
                    }
                    setTimeout(() => {
                        window.location.href = jsonResponse.url;
                    }, 1500); // Petit délai pour lire le feedback
                    return;
                }

                // --- GESTION SWITCH MODE (Agent Mial) ---
                if (action === "switch_to_agent") {
                    if (feedback) {
                        const fbDiv = document.getElementById("actionFeedback");
                        if (fbDiv) { fbDiv.innerText = feedback; fbDiv.style.opacity = 1; }
                    }

                    // Transition fluide
                    await playTone(); // Petit ping de confirmation

                    // CHANGEMENT THÈME VISUEL -> BLEU FONCÉ
                    document.body.className = 'theme-agent';

                    // On arrête la boucle Récap
                    SESSION_ACTIVE = false;

                    // On démarre l'Agent
                    setTimeout(() => {
                        startAgentSession();
                    }, 1000);
                    return;
                }

                if (action === "stop") {
                    if (feedback) {
                        const fbDiv = document.getElementById("actionFeedback");
                        if (fbDiv) { fbDiv.innerText = feedback; fbDiv.style.opacity = 1; }
                    }
                    if (audioBase64) {
                        const blob = base64ToBlob(audioBase64, 'audio/mpeg'); // MP3 Native
                        await playAudio(blob);
                    }
                    resetUI("Session terminée.");
                    return;
                }

                // --- DÉTECTION MODE RÉCAP (Rose) ---
                // Si on avance dans le flux (state != init_choice) et qu'on est pas redirigé
                if (action !== "switch_to_agent" && jsonResponse.next_state !== "awaiting_choice" && jsonResponse.next_state !== "init_choice") {
                    // On applique le thème Rose si ce n'est pas déjà fait
                    if (!document.body.classList.contains('theme-agent')) {
                        document.body.classList.add('theme-recap');
                    }
                }

                if (jsonResponse.next_state) NEXT_STATE = jsonResponse.next_state;
                else NEXT_STATE = 'listening_action'; // Default reset

                if (jsonResponse.context_data) CONTEXT_DATA = jsonResponse.context_data;

                if (currentEmailId) CURRENT_EMAIL_ID = currentEmailId;

                if (feedback) {
                    const fbDiv = document.getElementById("actionFeedback");
                    if (fbDiv) {
                        fbDiv.innerText = feedback;
                        fbDiv.style.opacity = 1;
                        setTimeout(() => { fbDiv.style.opacity = 0; }, 5000);
                    }
                }

                updateUI('playing', "Mial parle...", jsonResponse.user_text || "");

                // 1. Ping Début
                await playTone();

                if (audioBase64) {
                    const audioBlob = base64ToBlob(audioBase64, 'audio/mpeg'); // MP3 Native
                    await playAudio(audioBlob);
                }

                // 2. Ping Fin (C'est à vous)
                await playTone();

                updateUI('recording', "À vous...");
                const userAudio = await recordAudio(4000);

                updateUI('processing', "Réflexion...");
                await startLoop({
                    profile_id: PROFILE_ID,
                    state: NEXT_STATE,
                    current_email_id: CURRENT_EMAIL_ID,
                    context_data: CONTEXT_DATA,
                    file: userAudio
                });

            } catch (e) {
                console.error(e);
                resetUI("Erreur : " + e.message);
            }
        }

        // ============================================================
        //  MODE AGENT (WebRTC Realtime)
        // ============================================================

        let pc = null;
        let dc = null;
        let isAgentActive = false;

        async function startAgentSession() {
            if (isAgentActive) return;

            try {
                updateUI('processing', "Connexion à Mial...");

                // 1. Obtenir le Token Éphémère (Proxy vers vocal.py via Nginx)
                const response = await fetch("/vocal-api/session", { method: "POST" });
                if (!response.ok) throw new Error("Erreur auth agent");
                const data = await response.json();
                const EPHEMERAL_KEY = data.client_secret.value;

                // 2. Init WebRTC
                pc = new RTCPeerConnection();
                isAgentActive = true;
                SESSION_ACTIVE = true; // Pour bloquer le bouton principal

                // Audio Output
                const audioEl = document.createElement("audio");
                audioEl.autoplay = true;
                pc.ontrack = e => audioEl.srcObject = e.streams[0];

                // Audio Input
                const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
                pc.addTrack(ms.getTracks()[0]);

                // Data Channel (Events & Tools)
                dc = pc.createDataChannel("oai-events");
                setupDataChannel(dc);

                // SDP Offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const baseUrl = "https://api.openai.com/v1/realtime";
                const model = "gpt-4o-realtime-preview-2024-12-17";
                const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
                    method: "POST",
                    body: offer.sdp,
                    headers: {
                        Authorization: `Bearer ${EPHEMERAL_KEY}`,
                        "Content-Type": "application/sdp"
                    },
                });

                const answer = { type: "answer", sdp: await sdpResponse.text() };
                await pc.setRemoteDescription(answer);

                // UI Update
                document.getElementById('main-mic').className = 'mic-btn-large recording'; // Rouge permanent
                document.getElementById('status-display').textContent = "Conversation en cours...";
                document.getElementById('transcript-display').textContent = "Agent Mial Connecté";

                // Petit son pour dire "Je suis là"
                await playTone();

            } catch (err) {
                console.error("Agent Error:", err);
                resetUI("Erreur Agent : " + err.message);
                isAgentActive = false;
            }
        }

        function stopAgentSession() {
            if (pc) pc.close();
            pc = null;
            isAgentActive = false;
            resetUI("Session terminée.");
        }

        function setupDataChannel(d) {
            // Initialisation de la conversation
            d.onopen = () => {
                // On donne le contexte utilisateur (Email)
                const userEmail = document.getElementById('user-display').innerText.replace('Connecté en tant que ', '').trim();

                const instructions = `L'utilisateur est ${userEmail}. 
                Commence par te présenter très brièvement : "Bonjour, je suis l'Agent Mial. Je peux lire, rechercher, répondre, transférer et classer vos emails."
                Puis demande ce que tu peux faire pour aider. Reste toujours concis et efficace.`;

                d.send(JSON.stringify({
                    type: "response.create",
                    response: {
                        modalities: ["text", "audio"],
                        instructions: instructions
                    }
                }));
            };

            d.onmessage = async (e) => {
                const msg = JSON.parse(e.data);

                // Transcription temps réel (Feedback visuel)
                if (msg.type === "response.audio_transcript.delta") {
                    document.getElementById('transcript-display').textContent = "Mial: ...";
                }
                if (msg.type === "response.audio_transcript.done") {
                    document.getElementById('transcript-display').textContent = "Mial: " + msg.transcript;
                }

                // GESTION DES OUTILS (Tools)
                if (msg.type === "response.output_item.done" && msg.item.type === "function_call") {
                    const item = msg.item;
                    handleToolCall(item, d);
                }
            };
        }

        async function handleToolCall(item, d) {
            const userEmail = document.getElementById('user-display').innerText.replace('Connecté en tant que ', '').trim();
            const args = JSON.parse(item.arguments);
            if (userEmail) args.from_email = userEmail;

            let endpoint = "";
            let feedbackMsg = "";

            try {
                if (item.name === "search_contact") endpoint = "/vocal-api/search-contact";
                else if (item.name === "send_email") { endpoint = "/vocal-api/send-email"; feedbackMsg = "Email envoyé !"; }
                else if (item.name === "list_emails") endpoint = "/vocal-api/list-emails";
                else if (item.name === "forward_email") { endpoint = "/vocal-api/forward-email"; feedbackMsg = "Email transféré !"; }
                else if (item.name === "categorize_email") { endpoint = "/vocal-api/categorize-email"; feedbackMsg = "Catégorie assignée !"; }

                if (endpoint) {
                    const resp = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(args)
                    });
                    const result = await resp.json();

                    // Send Output to Model
                    d.send(JSON.stringify({
                        type: "conversation.item.create",
                        item: { type: "function_call_output", call_id: item.call_id, output: JSON.stringify(result) }
                    }));

                    // Trigger Response
                    d.send(JSON.stringify({ type: "response.create" }));

                    // UI Feedback
                    if (result.success && feedbackMsg) {
                        const fb = document.getElementById("actionFeedback");
                        fb.innerText = feedbackMsg; fb.style.opacity = 1;
                        setTimeout(() => fb.style.opacity = 0, 4000);
                    }
                }
            } catch (e) {
                console.error("Tool Error:", e);
                // Send error to model so it knows
                d.send(JSON.stringify({
                    type: "conversation.item.create",
                    item: { type: "function_call_output", call_id: item.call_id, output: JSON.stringify({ error: e.message }) }
                }));
                d.send(JSON.stringify({ type: "response.create" }));
            }
        }

        // --- Helpers Audio ---
        function playAudio(blob) {
            return new Promise(resolve => {
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                GLOBAL_AUDIO = audio; // Enable Pause Control

                audio.onended = () => {
                    GLOBAL_AUDIO = null;
                    resolve();
                };

                audio.play().catch(e => {
                    console.error("Playback error:", e);
                    resolve(); // Skip if error
                });
            });
        }

        function recordAudio(ms) {
            return new Promise(async (resolve) => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    // On force WebM qui est bien supporté
                    const rec = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    const chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);

                    rec.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        resolve(blob);
                        try { stream.getTracks().forEach(track => track.stop()); } catch (e) { }
                    };

                    rec.start();

                    // DURÉE ÉTENDUE À 8 SECONDES
                    // Pour laisser le temps de dicter une réponse complète
                    setTimeout(() => {
                        if (rec.state === "recording") rec.stop();
                    }, 8000);

                } catch (e) {
                    console.error(e);
                    resolve(null);
                }
            });
        }

        function updateUI(cls, txt, transcript = "") {
            const btn = document.getElementById('main-mic');
            const wrapper = document.getElementById('micWrapper');

            // Reset classes
            btn.className = 'mic-button';
            btn.classList.add(cls); // playing, recording, processing

            // Animation Ripple
            if (cls === 'playing' || cls === 'recording' || cls === 'processing') {
                wrapper.classList.add('is-listening');
            } else {
                wrapper.classList.remove('is-listening');
            }

            document.getElementById('status-display').textContent = txt;
            if (transcript) document.getElementById('transcript-display').textContent = `"${transcript}"`;
        }

        function resetUI(txt = "Prêt") {
            SESSION_ACTIVE = false;
            const btn = document.getElementById('main-mic');
            const wrapper = document.getElementById('micWrapper');

            if (btn) btn.className = 'mic-button';
            if (wrapper) wrapper.classList.remove('is-listening');

            // Reset Thème
            document.body.className = '';

            document.getElementById('status-display').textContent = txt;
        }

        // --- SON CLOTURE/OUVERTURE ---
        const TONE_AUDIO = new Audio('assets/audio/ping.mp3');
        TONE_AUDIO.volume = 0.4; // Pas trop fort

        function playTone() {
            return new Promise(resolve => {
                // On clone pour pouvoir le jouer 2 fois de suite rapidement si besoin
                // ou simplement rewind
                TONE_AUDIO.currentTime = 0;
                TONE_AUDIO.play()
                    .then(() => {
                        // On attend la fin ? Non, c'est un ping court, on peut resolve tout de suite
                        // ou attendre un peu. Le user a dit "un petit bruit".
                        // Si c'est 0.5s, on attend pour pas que l'IA parle PARDESSUS.
                        setTimeout(resolve, 600);
                    })
                    .catch(e => {
                        // Si pas de fichier, on ignore silencieusement
                        // console.warn("Ping sound not found or blocked", e);
                        resolve();
                    });
            });
        }
    </script>
</body>

</html>