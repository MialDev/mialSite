<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mial Vocal ‚Äî mial</title>
    <link rel="icon" type="image/svg+xml" href="assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1fb6ff">
    <style>
        .vocal-frame {
            width: 100%;
            height: 100%;
            border: none;
            min-height: 75vh;
            display: block;
        }

        /* NEW STYLES FOR NATIVE VOCAL INTERFACE */
        .native-vocal-ui {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 24px;
        }

        .mic-btn.idle {
            background: #3b82f6;
            color: white;
        }

        .mic-btn.recording {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        .mic-btn.playing {
            background: #10b981;
            pointer-events: none;
        }

        .mic-btn.processing {
            background: #f59e0b;
            opacity: 0.8;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        #status-display {
            margin-top: 10px;
            font-size: 1.2rem;
            color: #475569;
            font-weight: 500;
            min-height: 1.5em;
        }

        #transcript-display {
            margin-top: 10px;
            color: #94a3b8;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <header id="site-header" class="nav">
        <div id="header-placeholder"></div>
    </header>

    <section class="section" style="padding-top: 140px; min-height: 100vh;">
        <div class="container">
            <div class="card glass-static" style="padding: 0; overflow: hidden; height: 75vh; position: relative;">

                <!-- NEW NATIVE INTERFACE (Active by Default) -->
                <div id="native-interface" class="native-vocal-ui">
                    <h2 style="margin-bottom: 30px; color: #1e293b;">Assistant Vocal Intelligent</h2>
                    <button id="main-mic" class="mic-btn idle" onclick="toggleVocalSession()">
                        üéôÔ∏è
                    </button>
                    <div id="status-display">Appuyez pour d√©marrer</div>
                    <div id="transcript-display"></div>
                </div>

                <!-- OLD IFRAME (Hidden backup, kept as requested) -->
                <div id="legacy-interface" style="display:none; height:100%;">
                    <!-- Iframe pointing to the local python server running vocal.py via Nginx Proxy -->
                    <iframe src="about:blank" class="vocal-frame" title="Interface Vocal" allow="microphone"></iframe>
                    <!-- Fallback / Helper message overlay -->
                    <div id="iframe-helper"
                        style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; z-index:-1; width:80%;">
                        <p class="muted">Chargement de l'interface vocale...</p>
                        <p style="font-size:0.8rem; color:#94a3b8;">Si le chargement est bloqu√© (logo stop),
                            <a id="fallback-link" href="#" target="_blank"
                                style="text-decoration:underline; color:#94a3b8;">cliquez
                                ici pour ouvrir dans un nouvel onglet</a>.
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <div id="footer-placeholder"></div>
    <script src="api.js"></script>
    <script src="main.js"></script>
    <script>
        // --- 1. LEGACY AUTH CHECK & CONFIG ---
        document.addEventListener('DOMContentLoaded', async () => {
            const iframe = document.querySelector('iframe.vocal-frame');
            const fallbackLink = document.getElementById('fallback-link');
            const vocalBase = (window.API_HOST || '') + '/vocal-api/';

            // Set initial/fallback URLs
            if (fallbackLink) fallbackLink.href = vocalBase;

            try {
                // Fetch User Session from Main Portal API
                const res = await fetch(apiUrl('/me'), { credentials: 'include' });
                if (res.status === 401) {
                    window.location.href = '/Connexion.html';
                    return;
                }
                const user = await res.json();
                console.log("Mial Vocal User detected:", user.email);

                // Initialize Native Session State with User Profile if needed
                // (We'll load profiles here to get ID for the Native Runner)
                await loadProfilesForNative();

                // Update Iframe Source (Legacy) - Just in case user wants it
                if (iframe && user.email) {
                    iframe.src = `${vocalBase}?email=${encodeURIComponent(user.email)}`;
                } else if (iframe) {
                    iframe.src = vocalBase;
                }
            } catch (e) {
                console.error("Error checking session:", e);
                // Fallback: let iframe load default
                if (iframe) iframe.src = vocalBase;
            }
        });

        // --- 2. NEW NATIVE LOGIC ---
        let SESSION_ACTIVE = false;
        let CURRENT_PROFILE_ID = null;
        let currentEmailId = null;

        async function loadProfilesForNative() {
            try {
                const res = await fetch(apiUrl('/my/profiles'), { credentials: 'include' });
                const profiles = await res.json();
                if (profiles && profiles.length > 0) {
                    CURRENT_PROFILE_ID = profiles[0].id; // Default to first
                }
            } catch (e) { console.error("Profile load error", e); }
        }

        async function toggleVocalSession() {
            // Switch to Native if not already visible (it is default now, but logic robust)
            if (SESSION_ACTIVE) return;

            if (!CURRENT_PROFILE_ID) {
                alert("Impossible de charger votre profil. Veuillez r√©essayer.");
                await loadProfilesForNative();
                return;
            }

            SESSION_ACTIVE = true;
            document.getElementById('main-mic').className = 'mic-btn processing';
            startVocalLoop('start');
        }

        async function startVocalLoop(state, userAudioBlob = null) {
            const statusFn = (txt) => document.getElementById('status-display').textContent = txt;
            const btn = document.getElementById('main-mic');

            try {
                statusFn(state === 'start' ? "Connexion..." : "R√©flexion...");
                btn.className = 'mic-btn processing';

                let fd = new FormData();
                if (CURRENT_PROFILE_ID) fd.append('profile_id', CURRENT_PROFILE_ID);
                fd.append('state', state);
                if (currentEmailId) fd.append('current_email_id', currentEmailId);
                if (userAudioBlob) fd.append('file', userAudioBlob, 'input.webm');

                // CALL API
                const res = await fetch(apiUrl('/vocal/interact'), {
                    method: 'POST',
                    body: fd,
                    credentials: 'include'
                });

                if (!res.ok) throw new Error("API Error");

                // ACTION CHECK
                if (res.headers.get("X-Action") === "stop") {
                    statusFn("Session termin√©e.");
                    const blob = await res.blob();
                    await playAudio(blob);
                    resetUI();
                    return;
                }

                currentEmailId = res.headers.get("X-Current-Email-ID");

                // PLAY BOT AUDIO
                statusFn("Mial parle...");
                btn.className = 'mic-btn playing';
                const audioBlob = await res.blob();
                await playAudio(audioBlob);

                // RECORD USER
                statusFn("√Ä vous (Parlez)...");
                btn.className = 'mic-btn recording';
                const userRec = await recordUserAudio(4000); // 4s

                // LOOP
                await startVocalLoop('listening', userRec);

            } catch (e) {
                console.error(e);
                statusFn("Erreur : " + e.message);
                resetUI();
            }
        }

        function playAudio(blob) {
            return new Promise((resolve) => {
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.onended = resolve;
                audio.play();
            });
        }

        function recordUserAudio(durationMs) {
            return new Promise(async (resolve, reject) => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    const chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = () => resolve(new Blob(chunks, { type: 'audio/webm' }));
                    recorder.start();
                    setTimeout(() => recorder.stop(), durationMs);
                } catch (e) { reject(e); }
            });
        }

        function resetUI() {
            SESSION_ACTIVE = false;
            document.getElementById('main-mic').className = 'mic-btn idle';
            document.getElementById('status-display').textContent = "Appuyez pour d√©marrer";
        }
    </script>
</body>

</html>