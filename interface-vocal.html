<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mial Vocal - Interface</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0ea5e9;
            --primary-hover: #0284c7;
            --bg-glass: rgba(255, 255, 255, 0.7);
            --border-glass: rgba(255, 255, 255, 0.5);
            --text-dark: #1e293b;
            --text-muted: #64748b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at center, #ffffff, #eef2ff);
            /* Fond opaque pour cacher "Chargement..." */
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .vocal-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* --- MIC ANIMATION --- */
        .mic-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .mic-wrapper:hover {
            transform: scale(1.05);
        }

        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            position: relative;
            border: none;
            outline: none;
        }

        .mic-button svg {
            width: 32px;
            height: 32px;
            fill: white;
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(14, 165, 233, 0.3);
            opacity: 0;
            z-index: 1;
            transform: scale(0.8);
        }

        .is-listening .ripple {
            animation: ripple-anim 2s infinite;
        }

        .is-listening .ripple:nth-child(2) {
            animation-delay: 0.5s;
        }

        .is-listening .ripple:nth-child(3) {
            animation-delay: 1.0s;
        }

        @keyframes ripple-anim {
            0% {
                transform: scale(0.8);
                opacity: 0.6;
            }

            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }

        /* --- STATUS TEXT --- */
        .status-text {
            margin-top: 2rem;
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--text-dark);
            min-height: 1.5em;
            text-align: center;
        }

        .sub-status {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* --- CONTROLS --- */
        .controls {
            margin-top: 3rem;
            display: flex;
            gap: 1rem;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #94a3b8;
            color: var(--text-dark);
        }

        /* --- WAVEFORM VISUALIZER (Simple CSS) --- */
        .visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 40px;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .is-listening+.status-text+.visualizer,
        /* Ordre DOM */
        .visualizer.active {
            opacity: 1;
        }

        .bar {
            width: 4px;
            background: #0ea5e9;
            border-radius: 2px;
            animation: equal 1s infinite ease-in-out;
        }

        @keyframes equal {

            0%,
            100% {
                height: 10px;
            }

            50% {
                height: 30px;
            }
        }

        .bar:nth-child(odd) {
            animation-duration: 0.8s;
        }

        .bar:nth-child(2n) {
            animation-duration: 1.1s;
        }

        .bar:nth-child(3n) {
            animation-duration: 1.3s;
        }
    </style>
</head>

<body>

    <div class="vocal-container">
        <!-- Microphone Button -->
        <div class="mic-wrapper" id="micWrapper">
            <div class="ripple"></div>
            <div class="ripple"></div>
            <div class="ripple"></div>
            <button class="mic-button" id="micBtn">
                <!-- Mic Icon -->
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                    <path
                        d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                </svg>
            </button>
        </div>

        <!-- Text Status -->
        <div class="status-text" id="statusText">Cliquez pour parler</div>

        <!-- Visualizer -->
        <div class="visualizer" id="visualizer">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>

        <p class="sub-status" id="subStatus">Mial Vocal est prêt.</p>

        <!-- Actions -->
        <div class="controls">
            <a href="/login" class="btn-secondary" id="loginBtn">Se connecter (Microsoft)</a>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        // Logique JS Simplifiée pour WebRTC (OpenAI Realtime)
        // Note: Le code complet WebRTC OpenAI est complexe.
        // Ici on met la coquille visuelle et la connexion de base.

        const micWrapper = document.getElementById('micWrapper');
        const statusText = document.getElementById('statusText');
        const subStatus = document.getElementById('subStatus');
        const visualizer = document.getElementById('visualizer');
        const loginBtn = document.getElementById('loginBtn');

        let isListening = false;
        let pc = null;
        let dc = null;

        // Configuration pour la session OpenAI Realtime
        async function startSession() {
            try {
                statusText.innerText = "Connexion...";

                // 1. Get Ephemeral Token from our Backend
                const response = await fetch("/session", { method: "POST" });
                if (!response.ok) throw new Error("Erreur session");
                const data = await response.json();

                // 2. Init WebRTC
                const EPHEMERAL_KEY = data.client_secret.value;

                pc = new RTCPeerConnection();

                // Setup Audio Element for Model Output
                const audioEl = document.createElement("audio");
                audioEl.autoplay = true;
                pc.ontrack = e => audioEl.srcObject = e.streams[0];

                // Add Local Microphone
                const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
                pc.addTrack(ms.getTracks()[0]);

                // Data Channel for Events
                dc = pc.createDataChannel("oai-events");
                setupDataChannel(dc);

                // Offer / Answer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const baseUrl = "https://api.openai.com/v1/realtime";
                const model = "gpt-4o-realtime-preview-2024-12-17";

                const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
                    method: "POST",
                    body: offer.sdp,
                    headers: {
                        Authorization: `Bearer ${EPHEMERAL_KEY}`,
                        "Content-Type": "application/sdp"
                    },
                });

                const answer = {
                    type: "answer",
                    sdp: await sdpResponse.text(),
                };
                await pc.setRemoteDescription(answer);

                // UI Update
                isListening = true;
                micWrapper.classList.add('is-listening');
                visualizer.classList.add('active');
                statusText.innerText = "Je vous écoute...";
                subStatus.innerText = "Parlez naturellement.";

            } catch (err) {
                console.error(err);
                statusText.innerText = "Erreur de connexion";
                subStatus.innerText = err.message;
                stopSession();
            }
        }

        function stopSession() {
            if (pc) pc.close();
            pc = null;
            isListening = false;
            micWrapper.classList.remove('is-listening');
            visualizer.classList.remove('active');
            statusText.innerText = "Cliquez pour parler";
            subStatus.innerText = "Mial Vocal est prêt.";
        }

        function setupDataChannel(d) {
            d.onopen = () => {
                // Initial event
                const event = {
                    type: "response.create",
                    response: {
                        modalities: ["text", "audio"],
                        instructions: "Salue l'utilisateur brièvement.",
                    },
                };
                d.send(JSON.stringify(event));
            };

            d.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                // Handle function calls (tool_calls) here if needed via JS or Backend
                // The current backend config handles prompts, but execution logic 
                // for tools is often client-side or echoed back.
                // For 'send_email', the model might ask for confirmation.
                console.log("Event:", msg);
            };
        }

        /* --- ACTIONS -- */
        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Ouvrir dans une popup centrée
            const w = 600, h = 700;
            const y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
            const x = window.top.outerWidth / 2 + window.top.screenX - (w / 2);
            window.open('/login', 'MicrosoftLogin', `toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=${w}, height=${h}, top=${y}, left=${x}`);
        });

        // Ecouter le retour de la popup de login
        window.addEventListener("message", (event) => {
            if (event.data && event.data.type === 'MIAL_LOGIN_SUCCESS') {
                console.log("Login Success:", event.data.email);

                // Mettre à jour l'UI
                loginBtn.style.display = 'none';

                const connectedMsg = document.createElement('div');
                connectedMsg.innerHTML = `✅ Connecté : <strong>${event.data.email}</strong>`;
                connectedMsg.style.color = '#10b981';
                connectedMsg.style.marginTop = '1rem';
                document.querySelector('.controls').appendChild(connectedMsg);

                statusText.innerText = "Connecté ! Cliquez pour parler";
            }
        });

        micWrapper.addEventListener('click', () => {
            if (!isListening) {
                startSession();
            } else {
                stopSession();
            }
        });

    </script>
</body>

</html>