<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard — mial</title>
    <link rel="icon" type="image/svg+xml" href="assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1fb6ff">
</head>

<body>

    <header id="site-header" class="nav">
        <div class="container nav-inner">
            <a href="accueil.html" class="brand">
                <img class="brand-logo" src="assets/logos/logo-mial-full-color.svg" alt="mial logo" width="88"
                    height="88">
            </a>
            <button class="nav-toggle" type="button" aria-label="Ouvrir le menu">
                <span class="nav-toggle-bar"></span>
            </button>
            <nav class="nav-links">
                <a href="accueil.html">Accueil</a>
                <a href="dashboard.html" style="font-weight: 600;">Tableau de bord</a>
                <a href="account.html">Mon Compte</a>
                <button id="logout-btn" class="btn btn-ghost"
                    style="border:none; background:transparent; font-size: 0.95rem; cursor:pointer;">Déconnexion</button>
            </nav>
        </div>
    </header>

    <section class="section" style="padding-top: 140px;">
        <div class="container">

            <div class="card glass-static" style="margin-bottom: 32px; padding: 32px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h1 style="font-size: 1.8rem; margin-bottom: 8px;">Tableau de bord</h1>
                        <p class="muted">Bienvenue, <span id="user-email"
                                style="font-weight:600; color:var(--ink);">...</span></p>
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button class="btn btn-primary btn-small" onclick="showEditor()">＋ Configurer un nouveau
                            récap</button>
                        <button class="btn btn-ghost btn-small" onclick="location.reload()">Rafraîchir</button>
                    </div>
                </div>
            </div>

            <!-- VIEW LIST -->
            <div id="view-list">
                <div class="card glass-static" style="padding: 0; overflow:hidden; min-height: 300px;">
                    <div style="padding: 24px 24px 12px; border-bottom: 1px solid rgba(148,163,184,.3);">
                        <h2 style="font-size: 1.25rem; margin:0;">Vos Profils de Récap</h2>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Source (Boîte)</th>
                                    <th>Destinataire</th>
                                    <th>Heures</th>
                                    <th>Status</th>
                                    <th style="text-align:right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="profiles-body">
                                <tr>
                                    <td colspan="5" style="text-align:center; padding: 40px;" class="muted">
                                        Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Old Edit Section (Hidden by default, used for existing profiles) -->
                <!-- Ideally we'd merge this, but for now let's keep it functionally safe as legacy editor,
                     or we hide it if user clicks "create". -->
                <section id="profile-editor" class="card glass-static" style="margin-top:24px; display:none;">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px;">
                        <div>
                            <h3 style="margin:0;">Modifier Profil (Legacy)</h3>
                            <div class="muted" style="font-size:0.9rem;">ID: <span id="edit-profile-id"></span></div>
                        </div>
                        <button class="btn btn-ghost btn-small" id="editor-close">Fermer</button>
                    </div>
                    <div id="editor-ok" style="display:none; margin-bottom:12px; color:#16a34a;">Sauvegardé !</div>
                    <div id="editor-error" style="display:none; margin-bottom:12px; color:#ef4444;"></div>
                    <form id="form-settings-legacy" class="form">
                        <!-- Same fields as before ... -->
                        <div class="grid-2"
                            style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                            <label>Heure début <input id="legacy-start" type="time" step="1" /></label>
                            <label>Heure fin <input id="legacy-end" type="time" step="1" /></label>
                        </div>
                        <label style="margin-bottom:16px; display:block;">Timezone <input id="legacy-timezone"
                                type="text" /></label>
                        <button type="button" class="btn btn-primary" id="save-settings-legacy">Enregistrer</button>
                    </form>
                </section>
            </div>

            <!-- VIEW EDITOR (CREATION) -->
            <div id="view-editor" class="card glass-static" style="display:none; padding:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2 style="margin:0;">Configurer un Récapitulatif</h2>
                    <button class="btn btn-ghost btn-small" onclick="hideEditor()">Fermer</button>
                </div>

                <form id="form-editor" class="form">
                    <!-- 1. Compte & Destinataire -->
                    <div class="grid-2"
                        style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px;">
                        <div>
                            <label class="form-label" style="font-weight:600; margin-bottom:8px; display:block;">Compte
                                Source</label>
                            <select id="f-account" required
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0; background:white;">
                                <option value="">Chargement...</option>
                            </select>
                            <p class="muted" style="font-size:0.85rem; margin-top:4px;">La boîte mail connectée qui sera
                                analysée.</p>
                        </div>
                        <div>
                            <label class="form-label" style="font-weight:600; margin-bottom:8px; display:block;">Email
                                qui reçoit le récap</label>
                            <input type="email" id="f-recipient" required placeholder="votre@email.com"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
                            <p class="muted" style="font-size:0.85rem; margin-top:4px;">Où envoyer le résumé ?</p>
                        </div>
                    </div>

                    <!-- 2. Horaires -->
                    <div
                        style="background:rgba(248,250,252,0.6); padding:20px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:24px;">
                        <h4 style="margin-top:0; margin-bottom:16px; color:#334155;">Planification & Analyse</h4>

                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                            <div>
                                <label style="font-weight:600; display:block; margin-bottom:8px;">Heure d'envoi du
                                    récap</label>
                                <input type="time" id="f-schedule" required value="08:00"
                                    style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
                            </div>
                            <div>
                                <label style="font-weight:600; display:block; margin-bottom:8px;">Plage analysée (Emails
                                    reçus)</label>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span class="muted">De</span>
                                    <input type="time" id="f-start" required value="08:00"
                                        style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
                                    <span class="muted">à</span>
                                    <input type="time" id="f-end" required value="18:00"
                                        style="flex:1; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Audio & Options -->
                    <div class="grid-2"
                        style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px;">
                        <!-- Audio -->
                        <div
                            style="background:rgba(248,250,252,0.6); padding:20px; border-radius:12px; border:1px solid #e2e8f0;">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <label style="font-weight:600; cursor:pointer;" for="f-audio">Audio Actif
                                    (Podcast)</label>
                                <label class="toggle">
                                    <input id="f-audio" type="checkbox" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <label style="display:block; margin-bottom:4px; font-size:0.9rem;">Voix IA</label>
                            <select id="f-voice"
                                style="width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
                                <option value="alloy">Alloy (Neutre)</option>
                                <option value="echo">Echo (Masculin)</option>
                                <option value="fable">Fable (Anglais)</option>
                                <option value="onyx">Onyx (Profond)</option>
                                <option value="nova">Nova (Féminin)</option>
                                <option value="shimmer">Shimmer (Clair)</option>
                            </select>
                        </div>

                        <!-- Options -->
                        <div
                            style="background:rgba(248,250,252,0.6); padding:20px; border-radius:12px; border:1px solid #e2e8f0;">
                            <h4 style="margin-top:0; margin-bottom:12px; color:#334155;">Options</h4>
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <label style="font-weight:600; cursor:pointer;" for="f-unread">Seulement non-lus</label>
                                <label class="toggle">
                                    <input id="f-unread" type="checkbox" />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <label style="font-weight:600; cursor:pointer;" for="f-status">Profil Actif</label>
                                <label class="toggle">
                                    <input id="f-status" type="checkbox" checked />
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="editor-msg" style="margin-bottom:16px; font-weight:500; display:none;"></div>

                    <div
                        style="display:flex; justify-content:flex-end; gap:12px; padding-top:16px; border-top:1px solid #eee;">
                        <button type="button" class="btn btn-ghost" onclick="hideEditor()">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="saveProfile()">Enregistrer le
                            récap</button>
                    </div>
                </form>
            </div>

        </div>
    </section>

    <footer class="footer">
        <div class="container center">
            <p class="muted">© 2025 mial — Dashboard · <a href="mentions-legales.html">Mentions Légales</a></p>
        </div>
    </footer>

    <script src="main.js"></script>
    <script src="/api.js"></script>
    <script>
        function escapeHtml(s) { return String(s ?? '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'); }

        let PROFILES_BY_ID = new Map();
        let currentProfileId = null; // for legacy edit

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth & List
            try {
                const res = await fetch(apiUrl('/me'), { credentials: 'include' });
                if (res.status === 401) window.location.href = 'login.html';
                const user = await res.json();
                if (user.role === 'admin' || user.is_admin) window.location.replace('/admin/dashboard.html');
                document.getElementById('user-email').textContent = user.email;
            } catch (e) { window.location.href = 'login.html'; }

            loadProfiles();

            document.getElementById('logout-btn').addEventListener('click', async () => {
                await fetch(apiUrl('/auth/logout'), { method: 'POST', credentials: 'include' }).catch(e => { });
                window.location.href = 'login.html';
            });

            // Legacy Edit listeners...
            document.getElementById('editor-close').addEventListener('click', () => {
                document.getElementById('profile-editor').style.display = 'none';
            });
            document.getElementById('save-settings-legacy').addEventListener('click', saveLegacy);
        });

        // --- LIST VIEW ---
        async function loadProfiles() {
            const tbody = document.getElementById('profiles-body');
            try {
                const res = await fetch(apiUrl('/my/profiles'), { credentials: 'include' });
                if (!res.ok) throw new Error("Erreur chargement profils");
                const profiles = await res.json();
                PROFILES_BY_ID.clear();
                if (!profiles || profiles.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px;">Aucun profil configuré.</td></tr>`;
                    return;
                }
                tbody.innerHTML = profiles.map(p => {
                    PROFILES_BY_ID.set(p.id, p);
                    const activeBadge = (String(p.status).toLowerCase() === 'active') ?
                        `<span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:12px; font-size:0.8rem;">Actif</span>` :
                        `<span style="background:#f1f5f9; color:#64748b; padding:2px 8px; border-radius:12px; font-size:0.8rem;">Inactif</span>`;
                    return `<tr>
                        <td><strong>${escapeHtml(p.account_email || '—')}</strong></td>
                        <td>${escapeHtml(p.recap_recipient || '—')}</td>
                        <td>${escapeHtml(p.heure_debut)} - ${escapeHtml(p.heure_fin)}</td>
                        <td>${activeBadge}</td>
                        <td style="text-align:right;"><button class="btn btn-ghost btn-small" onclick="openLegacyEditor('${p.id}')">Modifier</button></td>
                    </tr>`;
                }).join('');
            } catch (e) { tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">${e.message}</td></tr>`; }
        }

        // --- NEW EDITOR LOGIC ---
        const viewList = document.getElementById('view-list');
        const viewEditor = document.getElementById('view-editor');
        const editorMsg = document.getElementById('editor-msg');

        window.showEditor = async function () {
            viewList.style.display = 'none';
            viewEditor.style.display = 'block';
            editorMsg.style.display = 'none';

            // Prefill recipient
            const uEmail = document.getElementById('user-email').textContent;
            if (uEmail && uEmail !== '...') document.getElementById('f-recipient').value = uEmail;

            // Load Accounts
            const fAccount = document.getElementById('f-account');
            fAccount.innerHTML = '<option value="">Chargement...</option>';
            try {
                let res = await fetch(apiUrl('/my/mailboxes'), { credentials: 'include' });
                // Fallback handling if route differs
                if (res.status === 404) res = await fetch(apiUrl('/mailbox/status'), { credentials: 'include' });

                if (!res.ok) throw new Error("Erreur");
                let data = await res.json();
                const list = Array.isArray(data) ? data : (data.connected ? [data] : []);

                if (list.length === 0) {
                    fAccount.innerHTML = '<option value="">Aucune boîte connectée</option>';
                    return;
                }
                fAccount.innerHTML = list.map(mb => `<option value="${mb.email_account_id || mb.id}">${escapeHtml(mb.email)}</option>`).join('');
            } catch (e) { fAccount.innerHTML = '<option value="">Erreur chargement</option>'; }
        };

        window.hideEditor = function () {
            viewEditor.style.display = 'none';
            viewList.style.display = 'block';
        };

        window.saveProfile = async function () {
            editorMsg.style.display = 'none';
            const fAccount = document.getElementById('f-account').value;
            const fRecipient = document.getElementById('f-recipient').value;

            if (!fAccount) { showMsg("Sélectionnez une boîte mail.", "red"); return; }
            if (!fRecipient) { showMsg("Email destinataire requis.", "red"); return; }

            const payload = {
                email_account_id: fAccount,
                recap_recipient: fRecipient,
                schedule_time: document.getElementById('f-schedule').value,
                heure_debut: document.getElementById('f-start').value,
                heure_fin: document.getElementById('f-end').value,
                audio_active: document.getElementById('f-audio').checked,
                voice: document.getElementById('f-voice').value,
                only_unread: document.getElementById('f-unread').checked,
                status: document.getElementById('f-status').checked ? 'Active' : 'Inactive',
                timezone: 'Europe/Paris' // Default
            };

            // Time format fix
            ['schedule_time', 'heure_debut', 'heure_fin'].forEach(k => {
                if (payload[k] && payload[k].length === 5) payload[k] += ':00';
            });

            try {
                const res = await fetch(apiUrl('/my/profiles'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(await res.text());

                showMsg("Profil créé avec succès !", "green");
                setTimeout(() => { hideEditor(); loadProfiles(); }, 1000);
            } catch (e) { showMsg("Erreur: " + e.message, "red"); }
        };

        function showMsg(txt, col) {
            editorMsg.textContent = txt;
            editorMsg.style.color = (col === 'red' ? '#ef4444' : '#16a34a');
            editorMsg.style.display = 'block';
        }

        // --- LEGACY EDIT (Minimal) ---
        window.openLegacyEditor = function (id) {
            const p = PROFILES_BY_ID.get(id);
            if (!p) return;
            currentProfileId = id;
            document.getElementById('profile-editor').style.display = 'block';
            document.getElementById('legacy-start').value = p.heure_debut || '';
            document.getElementById('legacy-end').value = p.heure_fin || '';
            document.getElementById('legacy-timezone').value = p.timezone || '';
            document.getElementById('profile-editor').scrollIntoView();
        };

        async function saveLegacy() {
            if (!currentProfileId) return;
            const p = PROFILES_BY_ID.get(currentProfileId);
            const payload = {
                ...p, // dirty merge
                heure_debut: document.getElementById('legacy-start').value,
                heure_fin: document.getElementById('legacy-end').value,
                timezone: document.getElementById('legacy-timezone').value
            };
            // Time format fix
            ['heure_debut', 'heure_fin'].forEach(k => {
                if (payload[k] && payload[k].length === 5) payload[k] += ':00';
            });

            try {
                const res = await fetch(apiUrl(`/profiles/${currentProfileId}/settings`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });
                if (!res.ok) throw new Error(await res.text());
                document.getElementById('editor-ok').style.display = 'block';
                loadProfiles();
            } catch (e) { alert(e.message); }
        }

    </script>
</body>

</html>