<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard — mial</title>
    <link rel="icon" type="image/svg+xml" href="assets/logos/logo-mial-small-color.svg">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#1fb6ff">
    <style>
        .editor-section {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .editor-title {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.1rem;
            color: #334155;
            font-weight: 600;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 12px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #475569;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            border-color: #1fb6ff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(31, 182, 255, 0.1);
        }

        .form-helper {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* Range Slider */
        input[type=range] {
            width: 100%;
            cursor: pointer;
        }

        details>summary {
            list-style: none;
            /* remove triangle */
            outline: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary {
            margin-bottom: 16px;
        }
    </style>
</head>

<body>

    <header id="site-header" class="nav">
        <div class="container nav-inner">
            <a href="accueil.html" class="brand">
                <img class="brand-logo" src="assets/logos/logo-mial-full-color.svg" alt="mial logo" width="88"
                    height="88">
            </a>
            <button class="nav-toggle" type="button" aria-label="Ouvrir le menu">
                <span class="nav-toggle-bar"></span>
            </button>
            <nav class="nav-links">
                <a href="accueil.html">Accueil</a>
                <a href="dashboard.html" style="font-weight: 600;">Tableau de bord</a>
                <a href="account.html">Mon Compte</a>
                <button id="logout-btn" class="btn btn-ghost"
                    style="border:none; background:transparent; font-size: 0.95rem; cursor:pointer;">Déconnexion</button>
            </nav>
        </div>
    </header>

    <section class="section" style="padding-top: 140px;">
        <div class="container">

            <div class="card glass-static" style="margin-bottom: 32px; padding: 32px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h1 style="font-size: 1.8rem; margin-bottom: 8px;">Tableau de bord</h1>
                        <p class="muted">Bienvenue, <span id="user-email"
                                style="font-weight:600; color:var(--ink);">...</span></p>
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button class="btn btn-primary btn-small" onclick="showEditor()">＋ Configurer un nouveau
                            récap</button>
                        <button class="btn btn-ghost btn-small" onclick="location.reload()">Rafraîchir</button>
                    </div>
                </div>
            </div>

            <!-- VIEW LIST -->
            <div id="view-list">
                <div class="card glass-static" style="padding: 0; overflow:hidden; min-height: 300px;">
                    <div style="padding: 24px 24px 12px; border-bottom: 1px solid rgba(148,163,184,.3);">
                        <h2 style="font-size: 1.25rem; margin:0;">Vos Profils de Récap</h2>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="dashboard-table">
                            <thead>
                                <tr>
                                    <th>Source (Boîte)</th>
                                    <th>Destinataire</th>
                                    <th>Heures</th>
                                    <th>Status</th>
                                    <th style="text-align:right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="profiles-body">
                                <tr>
                                    <td colspan="5" style="text-align:center; padding: 40px;" class="muted">
                                        Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW EDITOR (Advanced) -->
            <div id="view-editor" style="display:none;">

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2 style="margin:0;">Configurer un Récapitulatif</h2>
                    <button class="btn btn-ghost btn-small" onclick="hideEditor()">Fermer sans sauver</button>
                </div>

                <form id="form-editor">

                    <!-- BLOC 1: Source & Destination -->
                    <div class="editor-section">
                        <h3 class="editor-title">1. Source & Destination</h3>
                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                            <div>
                                <label class="form-label">Compte à analyser</label>
                                <select id="f-account" class="form-select" required>
                                    <option value="">Chargement...</option>
                                </select>
                                <div class="form-helper">La boîte mail dont les emails seront résumés.</div>
                            </div>
                            <div>
                                <label class="form-label">Destinataire du récap</label>
                                <input type="email" id="f-recipient" class="form-input" required
                                    placeholder="votre@email.com">
                                <div class="form-helper">L'adresse qui recevra l'email de synthèse.</div>
                            </div>
                        </div>
                    </div>

                    <!-- BLOC 2: Planification -->
                    <div class="editor-section">
                        <h3 class="editor-title">2. Planification & Période</h3>
                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                            <div>
                                <label class="form-label">Heure d'envoi du récap</label>
                                <input type="time" id="f-schedule" class="form-input" required value="08:00">
                                <div class="form-helper">Quand souhaitez-vous recevoir votre mémo ?</div>
                            </div>
                            <div>
                                <label class="form-label">Historique d'analyse</label>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <span style="white-space:nowrap;">Analyser</span>
                                    <input type="number" id="f-history" class="form-input" value="1" min="1" max="7"
                                        style="width:80px;">
                                    <span style="white-space:nowrap;">jours en arrière</span>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top:16px;">
                            <label class="form-label">Plage horaire des emails analysés (Quotidien)</label>
                            <div style="display:flex; align-items:center; gap:12px; max-width:500px;">
                                <span>De</span>
                                <input type="time" id="f-start" class="form-input" required value="00:00">
                                <span>à</span>
                                <input type="time" id="f-end" class="form-input" required value="23:59">
                            </div>
                        </div>
                    </div>

                    <!-- BLOC 3: Filtres Intelligents -->
                    <details class="editor-section" style="cursor:pointer;">
                        <summary style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:600; font-size:1.1rem; color:#334155;">3. Filtres Intelligents
                                (Avancé)</span>
                            <span style="color:var(--primary); font-size:0.9rem;">Afficher / Masquer</span>
                        </summary>

                        <div style="margin-top:24px;">
                            <div style="display:flex; gap:24px; margin-bottom:24px;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <input type="checkbox" id="f-unread" style="width:18px; height:18px;">
                                    <label for="f-unread" style="cursor:pointer; font-weight:500;">Seulement les emails
                                        non-lus</label>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <label style="font-weight:500;">Tri :</label>
                                    <select id="f-sort" class="form-select" style="width:auto;">
                                        <option value="date_desc">Chronologique (Récents)</option>
                                        <option value="priority">Priorité IA</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                                <div>
                                    <label class="form-label">Expéditeurs Autorisés (Whitelist)</label>
                                    <textarea id="f-allow" class="form-textarea" rows="3"
                                        placeholder="client@vip.com, boss@company.com..."></textarea>
                                    <div class="form-helper">Séparez par des virgules. Si vide, tout est analysé.</div>
                                </div>
                                <div>
                                    <label class="form-label">Expéditeurs Exclus (Blacklist)</label>
                                    <textarea id="f-exclude" class="form-textarea" rows="3"
                                        placeholder="newsletter@pub.com, no-reply@..."></textarea>
                                    <div class="form-helper">Emails à ignorer totalement.</div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- BLOC 4: Audio & IA -->
                    <div class="editor-section">
                        <h3 class="editor-title">4. Audio & IA</h3>

                        <div
                            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:12px; border-bottom:1px solid #f1f5f9;">
                            <div>
                                <div style="font-weight:600; font-size:1.05rem;">Générer version Audio (Podcast)</div>
                                <div class="muted">Recevez un fichier audio MP3 de votre résumé.</div>
                            </div>
                            <label class="toggle">
                                <input id="f-audio" type="checkbox" checked />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="grid-2" style="display:grid; grid-template-columns:1fr 1fr; gap:24px;">
                            <div>
                                <label class="form-label">Voix IA</label>
                                <select id="f-voice" class="form-select">
                                    <option value="alloy">Alloy (Neutre & Moderne)</option>
                                    <option value="echo">Echo (Masculin Profond)</option>
                                    <option value="fable">Fable (Anglais / British)</option>
                                    <option value="onyx">Onyx (Homme Sérieux)</option>
                                    <option value="nova">Nova (Femme Dynamique)</option>
                                    <option value="shimmer">Shimmer (Femme Claire)</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Vitesse de lecture <span id="speed-val"
                                        style="color:var(--primary); font-weight:600; margin-left:8px;">1.0x</span></label>
                                <input type="range" id="f-speed" min="0.5" max="2.0" step="0.1" value="1.0"
                                    oninput="document.getElementById('speed-val').textContent = this.value + 'x'">
                            </div>
                        </div>

                        <div style="margin-top:16px; width:50%;">
                            <label class="form-label">Langue du résumé</label>
                            <select id="f-lang" class="form-select">
                                <option value="fr">Français</option>
                                <option value="en">Anglais</option>
                                <option value="es">Espagnol</option>
                            </select>
                        </div>
                    </div>

                    <div id="editor-msg"
                        style="margin-bottom:16px; font-weight:600; padding:12px; border-radius:8px; display:none;">
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:16px;">
                        <button type="button" class="btn btn-ghost" onclick="hideEditor()">Annuler</button>
                        <button type="button" class="btn btn-primary" onclick="saveProfile()"
                            style="min-width:180px;">Enregistrer le récap</button>
                    </div>

                </form>
            </div>

        </div>
    </section>

    <!-- Legacy Editor (Hidden, for viewing/editing old profiles if needed, can serve as debug) -->
    <div id="legacy-editor-container" style="display:none;"></div>

    <footer class="footer">
        <div class="container center">
            <p class="muted">© 2025 mial — Dashboard · <a href="mentions-legales.html">Mentions Légales</a></p>
        </div>
    </footer>

    <script src="main.js"></script>
    <script src="/api.js"></script>
    <script>
        function escapeHtml(s) { return String(s ?? '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;'); }

        let PROFILES_BY_ID = new Map();

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth & List
            try {
                const res = await fetch(apiUrl('/me'), { credentials: 'include' });
                if (res.status === 401) window.location.href = 'login.html';
                const user = await res.json();
                if (user.role === 'admin' || user.is_admin) window.location.replace('/admin/dashboard.html');
                document.getElementById('user-email').textContent = user.email;
            } catch (e) { window.location.href = 'login.html'; }

            loadProfiles();

            document.getElementById('logout-btn').addEventListener('click', async () => {
                await fetch(apiUrl('/auth/logout'), { method: 'POST', credentials: 'include' }).catch(e => { });
                window.location.href = 'login.html';
            });
        });

        // --- VIEW MANAGEMENT ---
        const viewList = document.getElementById('view-list');
        const viewEditor = document.getElementById('view-editor');
        const editorMsg = document.getElementById('editor-msg');

        // Fields
        const F = {
            account: document.getElementById('f-account'),
            recipient: document.getElementById('f-recipient'),
            schedule: document.getElementById('f-schedule'),
            history: document.getElementById('f-history'),
            start: document.getElementById('f-start'),
            end: document.getElementById('f-end'),
            unread: document.getElementById('f-unread'),
            sort: document.getElementById('f-sort'),
            allow: document.getElementById('f-allow'),
            exclude: document.getElementById('f-exclude'),
            audio: document.getElementById('f-audio'),
            voice: document.getElementById('f-voice'),
            speed: document.getElementById('f-speed'),
            lang: document.getElementById('f-lang')
        };

        window.hideEditor = function () {
            viewEditor.style.display = 'none';
            viewList.style.display = 'block';
        };

        window.showEditor = async function () {
            viewList.style.display = 'none';
            viewEditor.style.display = 'block';
            editorMsg.style.display = 'none';

            // Defaults
            const userEmail = document.getElementById('user-email').textContent;
            if (userEmail && userEmail !== '...') F.recipient.value = userEmail;

            // Reset Fields
            F.schedule.value = "08:00";
            F.start.value = "00:00";
            F.end.value = "23:59";
            F.history.value = 1;
            F.unread.checked = false;
            F.sort.value = "date_desc";
            F.allow.value = "";
            F.exclude.value = "";
            F.audio.checked = true;
            F.voice.value = "onyx";
            F.speed.value = 1.0; document.getElementById('speed-val').textContent = "1.0x";
            F.lang.value = "fr";

            // Load Accounts
            F.account.innerHTML = '<option value="">Chargement...</option>';
            try {
                let res = await fetch(apiUrl('/my/mailboxes'), { credentials: 'include' });
                // Fallback
                if (res.status === 404) res = await fetch(apiUrl('/mailbox/status'), { credentials: 'include' });

                if (!res.ok) throw new Error("Erreur");
                let data = await res.json();
                const list = Array.isArray(data) ? data : (data.connected ? [data] : []);

                if (list.length === 0) {
                    F.account.innerHTML = '<option value="">Aucune boîte connectée</option>';
                    return;
                }
                F.account.innerHTML = list.map(mb => `<option value="${mb.email_account_id || mb.id}">${escapeHtml(mb.email)}</option>`).join('');

                // Auto-select if single
                if (list.length === 1) F.account.selectedIndex = 0;

            } catch (e) { F.account.innerHTML = '<option value="">Erreur chargement</option>'; }
        };

        // --- SAVE ---
        window.saveProfile = async function () {
            editorMsg.style.display = 'none';
            if (!F.account.value) return showMsg("Sélectionnez une boîte mail.", "red");
            if (!F.recipient.value) return showMsg("Email destinataire requis.", "red");

            // Formatting Helpers
            const parseCsv = (val) => val.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
            const fixTime = (t) => (t && t.length === 5) ? t + ':00' : t;

            const payload = {
                email_account_id: F.account.value,
                recap_recipient: F.recipient.value,
                schedule_time: fixTime(F.schedule.value),
                heure_debut: fixTime(F.start.value),
                heure_fin: fixTime(F.end.value),

                // History / Filters
                jours_arriere_start: parseInt(F.history.value) || 1,
                jours_arriere_end: parseInt(F.history.value) || 1,
                only_unread: F.unread.checked,
                filters: {
                    sender: parseCsv(F.allow.value),
                    exclude: parseCsv(F.exclude.value),
                    // defaults
                    cc: [], destined_to: [], forwarded_from: []
                },
                sort_mode: F.sort.value,

                // Audio
                audio_actif: F.audio.checked,
                voice: F.voice.value,
                speed: parseFloat(F.speed.value),
                language: F.lang.value,

                // Meta
                status: 'Active',
                timezone: 'Europe/Paris',
                categories: 'ALL'
            };

            try {
                const res = await fetch(apiUrl('/my/profiles'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'include'
                });

                if (!res.ok) throw new Error(await res.text());

                showMsg("Profil créé avec succès !", "green");
                setTimeout(() => { hideEditor(); loadProfiles(); }, 1000);

            } catch (e) { showMsg("Erreur: " + e.message, "red"); }
        };

        function showMsg(txt, col) {
            editorMsg.textContent = txt;
            editorMsg.style.background = (col === 'red' ? '#fee2e2' : '#dcfce7');
            editorMsg.style.color = (col === 'red' ? '#991b1b' : '#166534');
            editorMsg.style.display = 'block';
            editorMsg.scrollIntoView({ behavior: 'smooth' });
        }

        // --- LIST VIEW ---
        async function loadProfiles() {
            const tbody = document.getElementById('profiles-body');
            try {
                const res = await fetch(apiUrl('/my/profiles'), { credentials: 'include' });
                if (!res.ok) throw new Error("Erreur chargement profils");
                const profiles = await res.json();
                PROFILES_BY_ID.clear();

                if (!profiles || profiles.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px;">Aucun profil configuré.</td></tr>`;
                    return;
                }
                tbody.innerHTML = profiles.map(p => {
                    PROFILES_BY_ID.set(p.id, p);
                    const activeBadge = (String(p.status).toLowerCase() === 'active') ?
                        `<span style="background:#dcfce7; color:#166534; padding:2px 8px; border-radius:12px; font-size:0.8rem;">Actif</span>` :
                        `<span style="background:#f1f5f9; color:#64748b; padding:2px 8px; border-radius:12px; font-size:0.8rem;">Inactif</span>`;
                    return `<tr>
                        <td><strong>${escapeHtml(p.account_email || '—')}</strong></td>
                        <td>${escapeHtml(p.recap_recipient || '—')}</td>
                        <td>${escapeHtml(p.heure_debut)} → ${escapeHtml(p.heure_fin)}</td>
                        <td>${activeBadge}</td>
                        <td style="text-align:right;">
                           <button class="btn btn-ghost btn-small" onclick="alert('Modifier: À venir dans la V2')">Modifier</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (e) { tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">${e.message}</td></tr>`; }
        }

    </script>
</body>

</html>